YUI.add("contact-search-box",function(t){var e,i=function(i){this.options=i,this.options.elValue=this.options.elValue||"value",this.options.hideInitially,this._contacts=null,this.queryEl=this.options.el,this.queryElEvent,this.listEl=null,e=this.options.DOMContainer||t.config.win,this.init()};i.prototype={langBundles:this.details.langBundles,init:function(){var e=this;if(!1!==this.options.showFollowingState&&(this.options.showFollowingState=!0),!this.queryEl)throw new Error("Need this.queryEl.");this.queryEl.on("keydown",this.keynav.bind(this)),this.queryElEvent=this.queryEl.on("keyup",this.search.bind(this)),this.wrapperEl=t.Node.create("<div/>"),this.wrapperEl.addClass("c-contact-search-autocomplete"),this.listEl=t.Node.create("<ul/>"),this.listEl.addClass("contact-list"),this.wrapperEl.appendChild(this.listEl),this.listEl.on("mouseover",function(t){var i=t.target.ancestor("li",!0);i&&i!==e.highlighted&&e._highlight(i)}),this.queryEl.ancestor().insertBefore(this.wrapperEl,this.queryEl),this.wrapperEl.appendChild(this.queryEl),this.options.clickContact=this.options.clickContact||function(t){var i=t.target.ancestor("[data-nsid]",!0),s=i?i.getData("nsid"):"";e.select(s)},this.listEl.delegate("click",this.options.clickContact,"li"),this.selectedIndex=0},keynav:function(t){38===t.keyCode?(t.preventDefault(),this.selectedIndex--,this.selectedIndex<0&&(this.selectedIndex=this.numShowing+this.selectedIndex),this._highlight(this.selectedIndex),this._scrollToNode(this.highlighted)):40===t.keyCode?(t.preventDefault(),this.selectedIndex++,this.selectedIndex>this.numShowing-1&&(this.selectedIndex=this.numShowing-this.selectedIndex),this._highlight(this.selectedIndex),this._scrollToNode(this.highlighted)):9===t.keyCode?this._visible&&this.highlighted&&(t.preventDefault(),this.select(this.highlighted.getData("nsid"))):13===t.keyCode&&this._visible&&this.highlighted&&(t.preventDefault(),t.target.ancestor(".share-view",!0)||t.target.ancestor(".fluid-share-panel-view",!0)?this.select(this.highlighted.getData("nsid")):this.options.clickContact(t,this.highlighted))},_highlight:function(e){var i=this.listEl.all("li"),s=e instanceof t.Node,n=s?e:i.item(e),o=s?i.indexOf(e):e;!n||n.hasClass("loading")||n.hasClass("no-members")||(i.removeClass("highlight"),n.addClass("highlight"),this.selectedIndex=o,this.highlighted=n)},_scrollToNode:function(t){var e=this.listEl.get("scrollTop"),i=e+this.listEl.get("clientHeight"),s=t.get("offsetTop"),n=s+t.get("clientHeight");e>s?this.listEl.set("scrollTop",s-5):i<n&&this.listEl.set("scrollTop",n-this.listEl.get("clientHeight")+5)},getContact:function(t){for(var e=0,i=this._contacts,s=i.length;e<s;e++)if(i[e].nsid===t&&!i[e].hide)return i[e]},hideFromSearch:function(t){t=t.trim(),this._contacts&&this._contacts.some(function(e){if(e.nsid.trim()===t)return e.hide=!0,!0})},resetSearch:function(){this._contacts&&this._contacts.forEach(function(t){t.hide=!1})},showInSearch:function(t){t=t.trim(),this._contacts&&this._contacts.some(function(e){if(e.nsid.trim()===t)return e.hide=!1,!0})},load:function(t){var e,i={},s=this;if(!this._busy)return this._end=!1,this._busy=!0,i.can_tag=this.options.canTag||0,e=this.options.appContext.getViewer().nsid,this.options.appContext.getModel("contacts-models",e).then(function(e){return i.page=1,i.perPage=3e3,i.per_page=3e3,s._loadMoreContacts(e,i,t)},function(){s._busy=!1,s.options.onError()})},_loadMoreContacts:function(t,e,i){var s=this;return this._busy=!0,s.options.loadingState&&!s.listEl.one("li.loading")&&s.appendLoader(),t.getValue("contacts").getPage(e).then(function(n){s._contacts=(s.processContactModels(n,!0,!0)||[]).concat(s._contacts||[]),i(),s._contacts&&0!==s._contacts.length||s.hide(),e.page<t.getValue("pages")&&(e.page++,s._loadMoreContacts(t,e,i))},function(){s._busy=!1,s.options.onError()})},processContactModels:function(e,i,s){var n,o,l,h=this;try{l=e.map(function(t){return t.toJSON()})||[]}catch(t){l=[]}if(!h.contactIds&&(h.contactIds={},h._contacts))for(o in h._contacts)h.contactIds[o.id]=!0;return(l=l.filter(function(t){return!h.contactIds[t.id]})).forEach(function(e,i){h.contactIds[e.id]=!0,e.realname=e.realname||e.username,e.isContact=s,e.buddyicon=t.URLHelper.getBuddyIconURL(e.nsid,e.iconfarm,e.iconserver)}),i&&h.options.me&&(n=h.options.me.toJSON(),t.APIHelper.response.removeProtocolFromURL(n.buddyicon),n.buddyicon=n.buddyicon.default,h.contactIds[n.id]=!0,n.me=!0,l.push(n)),h.options.hideInitially&&l.forEach(function(t){h.options.hideInitially.indexOf(t.nsid)>-1&&(t.hide=!0)}),l},destructor:function(){this.queryElEvent&&this.queryElEvent.detach&&this.queryElEvent.detach()},hide:function(t){t&&t.halt(),this._visible&&(this._visible=!1,this.highlighted=null,this.selectedIndex=0,this.selected=null,this.options.noShim||this._shimUp(!1),this.listEl.setStyle("display","none"),this.options.onHide&&this.options.onHide())},show:function(){this._visible||(this._visible=!0,this.options.noShim||this._shimUp(),this.listEl.setStyle("display","block"),this._reposition(),this.options.onShow())},_reposition:function(){var i,s={width:e.innerWidth||e.clientWidth,height:e.innerHeight||e.clientHeight},n=this.options.el,o=n.getDOMNode(),l=o.getBoundingClientRect(),h=this.listEl.getDOMNode().getBoundingClientRect(),a=!this._contacts&&this.options.upInitially,c=e===t.config.win?l.top:o.clientTop;this.options.dialogOffset&&(i=this.options.dialogOffset()),a||c>0&&c+h.height+25>s.height&&!this.options.alwaysDownward?(this.listEl.setStyle("top","auto"),this.listEl.setStyle("bottom","25px"),this.options.onOrientationChange&&this.options.onOrientationChange(!0)):(this.listEl.setStyle("top",i||null),this.listEl.setStyle("bottom",null),this.options.onOrientationChange&&this.options.onOrientationChange(!1),n.ancestor(".modal",!0)&&this.listEl.setStyle("maxHeight",s.height-c-25))},_shimUp:function(e){if(!1===e){if(!this._shim)return;return this._shim.detach("click").remove(),void(this._shim=null)}this._shim=t.Node.create("<div/>"),this._shim.addClass(this.options.shim),this._shim.on("click",this.hide.bind(this)),this.wrapperEl.appendChild(this._shim)},select:function(t){"string"==typeof t&&(t=this.getContact(t))&&this.queryEl.set("value",t.realname),t&&(this.selected=t,this.options.onSelect(t)),this.hide()},search:function(t){var e,i,s=this.queryEl.get(this.options.elValue),n=this,o=this.options.appContext.getViewer().nsid;if(t&&27===t.keyCode)return t.preventDefault(),void this.queryEl.blur();if(t&&-1!==[38,40,9].indexOf(t.keyCode))t.preventDefault();else{if(this._nameTest(s),this.selected=null,this.selectedIndex=0,this.abort=!1,""===s.trim())return this.abort=!0,this.hide();if(this.options.searchNonContacts||(this._end=!0,this._busy=!1),this._contacts&&this.options.me&&"me"===s)return this.showResults(this._contacts.filter(function(t){return!t.hide&&t.me}).concat(this._contacts.filter(function(t){return!t.hide&&n._matchesQuery(t)})));if(this._isEmail(s))return this.select({email:s,nsid:null});if(/,/.test(s))return this.select(null);if(!this._contacts){if(this.options.signedOut)return;this.showResults(),this.load(this.search.bind(this))}this._contacts&&(e=this._contacts.filter(function(t){return!t.hide&&n._matchesQuery(t)})),this.showResults(e),n.listEl.getDOMNode(),this.options.searchNonContacts&&(this.options.loadMoreOnScroll&&s.length>0?(i=1,clearTimeout(this.searchAllPeople),this.searchInstanceId=999999*Math.random(),this.searchAllPeople=setTimeout(function(){n._searchPeople(s,o,i,n.searchInstanceId,function(){n._busy=!1,n.showResults(n._contacts.filter(function(t){return!t.hide&&n._matchesQuery(t)})),n.listElScrollEvent=n.listEl.on("scroll",function(){n.listEl._node.clientHeight+n.listEl._node.scrollTop===n.listEl._node.scrollHeight&&(i++,n._loadMore(i,o,s))})})},500)):(clearTimeout(this.searchAllPeople),this.searchInstanceId=999999*Math.random()))}},_loadMore:function(t,e,i){var s=this;this._busy=!0,clearTimeout(this.searchAllPeople),this.searchInstanceId=999999*Math.random(),this.searchAllPeople=setTimeout(function(){s.options.loadingState&&!s.listEl.one("li.loading")&&s.appendLoader(),s._searchPeople(i,e,t,s.searchInstanceId,function(){s.showResults(s._contacts.filter(function(t){return!t.hide&&s._matchesQuery(t)})),s.listElScrollEvent&&s.listElScrollEvent.detach(),s.listElScrollEvent=s.listEl.on("scroll",function(){s.listEl._node.clientHeight+s.listEl._node.scrollTop===s.listEl._node.scrollHeight&&(t++,s._loadMore(t,e,i))})})},100)},_nameTest:function(e){var i=new RegExp(".*"+t.flutil.agnosticizeUnicode(e).replace(/\s/,"\\s")+".*","ig");this._matchesQuery=function(t){return i.test(t.username)||i.test(t.realname)||i.test(t.email)}},appendLoader:function(t){t=t||this.listEl;var e=document.createElement("li"),i=t.scrollTop;e.className="loading",e.innerHTML=this.options.loadingState,t.appendChild(e),t.scrollTop=i+e.clientHeight},_searchPeople:function(t,e,i,s,n){var o,l=this;l._end=!1,l.options.loadingState&&!l.listEl.one("li.loading")&&l.appendLoader(),l.options.appContext.getModel("contacts-models",e).then(function(e){return(o=e.search({username:t,page:i})).then(function(t){var e=t.people,i=l.processContactModels(e,!1,!1);l._contacts=l._contacts||[],l._contacts=l._contacts.concat(i),l._contacts.some(function(t){return l._matchesQuery(t)})||(l._end=!0),n()},function(){l._end=!0,l._busy=!1,n()})},function(){l._end=!0,l._busy=!1,n()})},_isEmail:function(t,e){t=/,/.test(t)?t.split(/,/):[t];var i=/^\s*[\w\-\+_]+(\.[\w\-\+_]+)*@[\w\-\+_]+\.[\w\-\+_]+(\.[\w\-\+_]+)*\s*$/;if(e){for(;t.length;)if(i.test(t.shift().trim()))return!0;return!1}for(;t.length;)if(!i.test(t.shift().trim()))return!1;return!0},showResults:function(e){if(!this.abort){var i,s,n=this.options.max||10,o=this;i=document.createDocumentFragment(),e&&this.selectedIndex>=e.length&&(this.selectedIndex=e.length-1),this.numShowing=Math.min(n,e&&e.length||0),!o._busy&&e&&0===e.length?((s=document.createElement("li")).innerHTML='<span class="no-contacts">'+this.intlMessage({intlName:"photo-page-scrappy.NO_MEMBERS_FOUND"})+"</span>",s.className="no-members",i.appendChild(s),o.highlighted=null):e&&e.slice(0,n).forEach(function(e,s,n){var l=o.createItem(e);s===o.selectedIndex&&(l.setAttribute("class","highlight"),o.highlighted=t.Node(l)),i.appendChild(l)}),!o._busy&&e||!o.options.loadingState||o.appendLoader(i),this.options.loadMoreOnScroll&&this.listElScrollEvent&&this.listElScrollEvent.detach(),this.listEl.setHTML(""),this.listEl.getDOMNode().appendChild(i),this.show()}},_template:function(){return['<img src="{{buddyicon}}">','<div class="following-status {{isContact}}">','<span class="following-icon">&nbsp;</span>',"<span>"+this.intlMessage({intlName:"common.FOLLOWING"})+"</span>","</div>",'<h2 class="all">{{realname}}</h2>','<h3 class="all">{{username}}</h3>'].join("")},_onlyContactTemplate:['<img src="{{buddyicon}}">',"<h2>{{realname}}</h2>","<h3>{{username}}</h3>"].join(""),createItem:function(e){var i,s=document.createElement("li"),n=this.options.searchNonContacts&&this.options.showFollowingState?this._template():this._onlyContactTemplate,o=this.options.truncateLength||70;return i=n.replace(/\{\{(\w+)\}\}/g,function(i,s){if("buddyicon"===s)return e[s];if("isContact"===s)return e[s]?"am-following":"";var n=t.flutil.escapeInput(e[s]);return t.Handlebars.helpers.truncate(n,o)}),s.innerHTML=i,s.dataset?(s.dataset=s.dataset,s.dataset.nsid=e.nsid,s.dataset.displayname=e.realname||e.username,s.dataset.pathAlias=e.pathAlias,s.dataset.ispro=e.isPro,s.dataset.probadge=e.proBadge):(s.setAttribute("data-nsid",e.nsid),s.setAttribute("data-displayname",e.realname||e.username),s.setAttribute("data-path-alias",e.pathAlias),s.setAttribute("data-ispro",e.isPro),s.setAttribute("data-probadge",e.proBadge)),s}},t.mix(i.prototype,t.Localizable),t.ContactSearchBox=i},"@VERSION@",{requires:["api-helper","flutil","handlebars-helpers","flickr-contacts-getListfetcher"],langBundles:["common","photo-page-scrappy"]});YUI.add("hermes-template-html5-balls",function(e,a){var l=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,a,l,t,r){return'\n<div class="html5-balls">\n\t<div class="blueball"></div>\n\t<div class="pinkball"></div>\n</div>\n'},useData:!0}),t={};e.Array.each([],function(a){var l=e.Template.get("hermes/"+a);l&&(t[a]=l)}),e.Template.register("hermes/html5-balls",function(a,r){return r=r||{},r.partials=r.partials?e.merge(t,r.partials):t,l(a,r)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-html4-balls",function(e,a){var r=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,a,r,t,l){return'\n<div class="html4-balls"></div>\n'},useData:!0}),t={};e.Array.each([],function(a){var r=e.Template.get("hermes/"+a);r&&(t[a]=r)}),e.Template.register("hermes/html4-balls",function(a,l){return l=l||{},l.partials=l.partials?e.merge(t,l.partials):t,r(a,l)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("html5-balls",function(e){var l,t=!(e.UA.ie&&e.UA.ie<9);l=function(e){return t?"html5-balls":"html4-balls"},e.augment(l,e.Attribute),e.Balls=l},"@VERSION@",{requires:["base","hermes-template-html5-balls","hermes-template-html4-balls","handlebars-helpers","template-base"]});YUI.add("fluid-share-panel-view",function(e,t){function i(e){return e.displayUrl||e.url||e.src}var s=require("hermes-core/flog")(t),a=(require("url-parse"),{}),n=["sq","q","t","s","n","w","m","z","c","b","l","h","k","3k","4k","5k","6k"],r={header:"false",footer:"false",context:"false",vr:"false"};a["embed-code-size-field"]="embed-code-text-field",a["iframe-code-size-field"]="iframe-code-text-field",a["bb-code-size-field"]="bb-code-text-field",e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.networkClasses=t.networkClasses||{},this.linkShareParams=t.linkShareParams,this.guestPassParams=t.guestPassParams||{},this.emailShareParams=t.emailShareParams,this.signedOutSharingPerms=t.signedOutSharingPerms||{},this.shareItemCount=t.shareItemCount||1,this.PERMISSIONS=[],this.guestPassParams.contentMarkedPublic&&this.PERMISSIONS.push({text:this.intlMessage({intlName:"share-modal.SHARE_PUBLIC_ONLY"}),value:"public"}),this.guestPassParams.canSharePrivate&&this.PERMISSIONS.push({text:this.intlMessage({intlName:"share-modal.SHARE_PRIVATE"}),value:"private"}),!1!==this.guestPassParams.shareNonPublic&&(this.guestPassParams.contentMarkedFriendFamily&&this.PERMISSIONS.push({text:this.intlMessage({intlName:"share-modal.SHARE_FRIENDS_AND_FAMILY"}),value:"family_and_friends"}),this.guestPassParams.contentMarkedFamily&&this.PERMISSIONS.push({text:this.intlMessage({intlName:"share-modal.SHARE_FAMILY"}),value:"family"}),this.guestPassParams.contentMarkedFriends&&this.PERMISSIONS.push({text:this.intlMessage({intlName:"share-modal.SHARE_FRIENDS"}),value:"friends"})),this.isMine=t.isMine||!1,this.cancel=!1,this.guestPasses={},this.flickrShare={recipients:[],guestpassStr:this.PERMISSIONS[0]?this.PERMISSIONS[0].value:"private",enablePrint:!1},r=e.StorageHelper.getItem("embedr-options")?JSON.parse(e.StorageHelper.getItem("embedr-options")):r,t.canVr?r.vr="true":r.vr="false",this},loadState:function(){var t=[],i=this;if(this.appContext.getViewer().nsid&&t.push(this.appContext.getModel("person-models",this.appContext.getViewer().nsid).then(function(e){i.set("me",e)})),this.guestPassParams.shareToAll)Object.keys(this.signedOutSharingPerms).forEach(function(e){i.networkClasses[e].canShare=!0});else if(this.guestPassParams.shareToSpecific)Object.keys(this.guestPassParams.shareToSpecific).forEach(function(e){i.networkClasses[e].canShare=i.guestPassParams.shareToSpecific[e].canShare,i.networkClasses[e].canNotShareTitle=i.guestPassParams.shareToSpecific[e].canNotShareTitle});else{var s={};s[this.emailShareParams.modelName+"_id"]=this.emailShareParams.modelId,this.emailShareParams.modelOwnerId&&(s.owner_id=this.emailShareParams.modelOwnerId),t.push(this._loadSharingPermissionsFromAPI(s))}return e.Promise.all(t)},_loadSharingPermissionsFromAPI:function(e){var t=this;return e.breakCache=(new Date).toISOString(),this.appContext.callAPI("flickr.sharing.canShare",e).then(function(e){e&&e.services&&e.services.service&&e.services.service.forEach(function(e){Object.keys(t.networkClasses).some(function(i){if(t.networkClasses[i].serviceId===e.serviceTypeId){if(t.networkClasses[i].canShare=!!e.canShare,"flickr"===i&&!1===t.appContext.getViewer().signedIn&&(t.networkClasses[i].canShare=!1),e.canShare||(t.networkClasses[i].canNotShareTitle=e.reason.map(function(e){return e.content}).join(", ")),130===e.serviceTypeId&&e.reason&&e.reason.length&&e.reason.some(function(e){return 3===e.code}))return t.cancelMessage=t.intlMessage({intlName:"share-modal.CANCEL_SHARE_BECAUSE_RESTRICTED"}),t.cancel=!0,!0;if(130===e.serviceTypeId){if(t.PERMISSIONS.length&&"public"!==t.PERMISSIONS[t.PERMISSIONS.length-1].value&&(t.guestpassRequired=!0),e.availableGuestpasses){1===e.guestpassRequired&&t.PERMISSIONS.length&&"public"===t.PERMISSIONS[t.PERMISSIONS.length-1].value&&t.PERMISSIONS.shift(),1===e.guestpassRequired&&(t.guestpassRequired=!0,t.guestPassParams=t.guestPassParams||{},t.guestPassParams.contentMarkedPublic=!1,t.guestPassParams.nonPublicWarning=!0);var s=!1,a=!1,n=!1;e.availableGuestpasses.guestpass.forEach(function(e){"friends"===e.content&&(s=!0),"family"===e.content&&(a=!0),"private"===e.content&&(n=!0)});for(var r=0;r<t.PERMISSIONS.length;)"friends"===t.PERMISSIONS[r].value&&!s||"family"===t.PERMISSIONS[r].value&&!a||"family_and_friends"===t.PERMISSIONS[r].value&&!a&&!s||"private"===t.PERMISSIONS[r].value&&!n?t.PERMISSIONS.splice(r,1):r++}else t.PERMISSIONS.length&&"public"===t.PERMISSIONS[t.PERMISSIONS.length-1].value&&(t.PERMISSIONS=[t.PERMISSIONS[0]]);t.flickrShare.guestpassStr=t.PERMISSIONS[0]?t.PERMISSIONS[0].value:"private"}return!0}return!1})})},function(e){s.error("Error reading canShare permissions",{err:e}),Object.keys(t.signedOutSharingPerms).forEach(function(e){t.networkClasses[e].canShare=t.signedOutSharingPerms[e].canShare})})},buildContainer:function(){var t,i=this.guestPassParams.showGuestPassDropdown&&this.isMine&&!!this.guestPassParams.type||!this.guestPassParams.contentMarkedPublic,s="";if(this.cancel)return this.setContainerWithTemplate("fluid-share-panel-error",{errorMessage:this.cancelMessage||this.intlMessage({intlName:"share-modal.CANCEL_SHARE_BECAUSE_ERROR",photoCount:this.guestPassParams.multipleItems?2:1})}),this;if(this.linkShareDisplay=this.generateLinkSharingDisplay(this.linkShareParams),s="macintosh"===e.UA.os?this.intlMessage({intlName:"share-modal.COPY_MAC"}):this.intlMessage({intlName:"share-modal.COPY_PC"}),t={networkClasses:this.networkClasses,linkShareDisplay:this.linkShareDisplay,privacyWarningString:this.linkShareParams.privacyWarningString,downloadAccessString:this.linkShareParams.downloadAccessString,showDownloadWarning:this.linkShareParams.showDownloadWarning,shareItemCount:this.shareItemCount,grabLink:this.guestPassParams.contentMarkedPublic||this.linkShareParams.generateLink?this.linkShareParams.shortURL:null,canHaveGuestpass:i,emailShareParams:this.emailShareParams,showMailPerms:this.guestPassParams.showGuestPassDropdown&&this.isMine&&this.guestPassParams.multipleItems&&this.PERMISSIONS.length>0,nonPublicWarning:this.guestPassParams.nonPublicWarning,grabLinkDefaultPermission:(i&&this.PERMISSIONS.length)>0?this.PERMISSIONS[0].text:"",copyMessage:s,choiceOfPermission:this.PERMISSIONS.length>1,displayOptions:r,showSlideshowOption:void 0!==this.linkShareParams.albumId||void 0!==this.linkShareParams.galleryId||void 0!==this.linkShareParams.userId||void 0!==this.linkShareParams.groupId||this.linkShareParams.isExplore,isEdge:this.appContext.getUA().isEdge,showOptionToEnablePrint:this.guestPassParams.showOptionToEnablePrint&&this.isMine,isMine:this.isMine},this.linkShareDisplay.embedr){var a,l=0,o=e.StorageHelper.getItem("fluid-share-panel-embedr-default-size");this.linkShareDisplay.embedr.sizes.forEach(function(e,t){if(o&&e.sizeKey===o&&(l=t,a=!0),!a){n.indexOf(e.sizeKey)>l&&(l=t)}}),t.defaultSizeStr=this.linkShareDisplay.embedr.sizes[l].sizeStr,t.defaultEmbedrCode=this.linkShareDisplay.embedr.sizes[l].embedCode,e.StorageHelper.setItem("fluid-share-panel-embedr-default-size",this.linkShareDisplay.embedr.sizes[l].sizeKey)}if(this.linkShareDisplay.bbCode){var h,d=0,c=e.StorageHelper.getItem("fluid-share-panel-bbCode-default-size");this.linkShareDisplay.bbCode.sizes.forEach(function(e,t){if(c&&e.sizeKey===c&&(d=t,h=!0),!h){n.indexOf(e.sizeKey)>d&&(d=t)}}),t.defaultBBCode=this.linkShareDisplay.bbCode.sizes[d].embedCode,t.defaultBBCodeSizeStr=this.linkShareDisplay.bbCode.sizes[d].sizeStr}if(this.linkShareDisplay.iframe){var u,m=0,p=e.StorageHelper.getItem("fluid-share-panel-iframe-default-size");this.linkShareDisplay.iframe.sizes.forEach(function(e,t){if(p&&e.sizeKey===p&&(m=t,u=!0),!u){n.indexOf(e.sizeKey)>m&&(m=t)}}),t.defaultIframeSizeStr=this.linkShareDisplay.iframe.sizes[m].sizeStr,t.defaultIframeCode=this.linkShareDisplay.iframe.sizes[m].embedCode}return this.linkShareDisplay.bbCode||this.linkShareDisplay.embedr||this.linkShareDisplay.iframe||(t.hideButtons=!0),t.moveInstructionsUp=t.hideButtons&&!t.canHaveGuestpass&&!t.choiceOfPermission,this.setContainerWithTemplate("fluid-share-panel",t),this},additionalViewClasses:function(){var e=[];return e.push("restyle"),e},activate:function(){var i=this.get("container"),s=this;if(this.registerEventHandler(i.delegate("click",function(e){e.preventDefault(),s.fire("subviewViewEvent","done-sharing")},".done-sharing")),this.guestpassRequired&&this.fire("subviewViewEvent","guestpass-required"),this.cancel)return this;this.dropdowns={},this.linkShareDisplay||(this.linkShareDisplay=this.generateLinkSharingDisplay(this.linkShareParams)),this.registerEventHandler(e.globalEvents.subscribe("window:keydown",function(t){(t.e.ctrlKey||t.e.metaKey)&&67===t.e.keyCode&&e.rapidTracker.beacon(s.name,"linkCopied-"+e.StorageHelper.getItem("fluid-share-panel-first-selected"))})),this.registerEventHandler(i.delegate(["click","keydown"],function(e){"click"!==e.type&&13!==e.keyCode||(e.preventDefault(),s._toggleLinkSelection(e,i))},".link-type-button")),this.registerEventHandler(i.delegate("change",function(e){e.currentTarget.getDOMNode().checked?(i.one(".embed-privacy-container").addClass("hide"),i.one(".embed-options-container").removeClass("hide")):(i.one(".embed-privacy-container").removeClass("hide"),i.one(".embed-options-container").addClass("hide"))},".embed-guestpass-checkbox")),this.registerEventHandler(i.delegate("click",function(e){e.preventDefault(),s._createdDropdownForEmbedIframeBB.bind(s)(e,i)},".embed-size-field")),this.registerEventHandler(i.delegate("click",function(e){e.preventDefault(),s._createGrabLinkPermissionDropdown(e,i)},".grab-link-field")),this.registerEventHandler(i.delegate("click",function(e){e.preventDefault(),s._createMailPermissionDropdown(e,i)},".mail-perm-field")),this.registerEventHandler(i.delegate("click",function(e){s.selectInput(e.target)},".bb-code-text-field, .grab-link-text-field, .embed-code-text-field")),e.use("event-touch",function(e){s.registerEventHandler(e.one("."+t).delegate("touchend",function(e){s.selectInput(e.target)},".bb-code-text-field, .grab-link-text-field, .embed-code-text-field"))}),this.registerEventHandler(i.delegate("click",function(t){s.networkClasses&&t.target.ancestor("."+s.networkClasses.flickr.className,!0)&&(t.preventDefault(),i.one(".share-panels").addClass("show-email-form"),e.rapidTracker.beacon(s.name,"emailTabClick"))},".share-link.sharing-type-enabled")),i.one(".share-by-email")&&this.registerEventHandler(i.one(".share-by-email").on("click",function(e){e.preventDefault(),s._onShareByEmail(e)})),this.registerEventHandler(i.delegate("change",function(e){e.halt(),s._updateEmbedrOptions(e)},".embed-options input")),this.isMine&&this.appContext.flipper.isFlipped("enable-guest-pass-printing")&&this.guestPassParams.showOptionToEnablePrint&&(this.registerEventHandler(i.delegate("change",s.handleChangePrintPermission.bind(s),"#enable-share-print")),this.registerEventHandler(i.delegate("change",s.handleChangePrintPermission.bind(s),"#enable-embed-print")),this.registerEventHandler(i.delegate("change",s.handleChangePrintPermission.bind(s),"#enable-email-print"))),this.setupEmailSharing();var a=this.PERMISSIONS[0].value;if(!this.linkShareParams.generateLink&&(this.guestpassRequired&&this.isMine&&-1===this.linkShareParams.url.indexOf("favorites")||"public"!==a)){"public"!==a&&i.one(".grab-link-privacy-reminder").removeClass("hide-reminder");var n=[1,1,1];"friends"===a?n=[0,1,0]:"family"===a?n=[1,0,0]:"family_and_friends"===a&&(n=[1,1,0]),this.requestGuestpass.apply(this,n)}return this.linkShareParams.generateLink&&(i.one(".grab-link-privacy-reminder").removeClass("hide-reminder"),this.generatingLink||(this.generatingLink=!0,this.startGuestpassLoader(),this.fire("subviewViewEvent","generate-link"))),this.setHighlightWidths(),i.one(".grab-link-download-reminder a").addClass("tabbable"),this},handleChangePrintPermission:function(t){t.halt();var i=this.get("container"),s=t.currentTarget.getDOMNode().checked,a=i.one(".grab-link-text-field"),n=a.getAttribute("data-perm-level"),r="public"===this.PERMISSIONS[0].value;s?(i.one("#enable-share-print").getDOMNode().checked=!0,i.one("#enable-embed-print").getDOMNode().checked=!0,i.one("#enable-email-print").getDOMNode().checked=!0):(i.one("#enable-share-print").getDOMNode().checked=!1,i.one("#enable-embed-print").getDOMNode().checked=!1,i.one("#enable-email-print").getDOMNode().checked=!1),this.isMine&&(this.startGuestpassLoader(),r&&!s?(a.set("value",this.linkShareParams.shortURL),this.updateEmbedCode(e.url(this.linkShareParams.embedUrl||this.linkShareParams.url)),this.endGuestpassLoader(),i.one(".grab-link-privacy-reminder").addClass("hide-reminder")):this.regenerateGuestPass(n))},onParentViewEvent:function(t,i){var s=this.get("container"),a=s.one(".grab-link-text-field"),n=e.StorageHelper.getItem("fluid-share-panel-first-selected")||"grabLinkItem";if("flickr-share-error"===i[0])this._onWarning(this.intlMessage({intlName:"share-modal.FLICKR_SHARE_ERROR"}));else if("flickr-share-success"===i[0]){var r=s.one(".fake-input");r.removeClass("not-empty"),r.all(".pill").remove(),s.one(".email-message-text-field").set("value",""),s.one(".email-recipient-text-field").setStyle("width","inherit"),s.one(".share-by-email").set("disabled",!0),this.contacts.resetSearch(),this.to={},this.flickrShare.recipients=[],this._onWarning(this.intlMessage({intlName:"share-modal.FLICKR_SHARE_SUCCESS"}),this.intlMessage({intlName:"share-modal.FLICKR_SHARE_SUCCESS_TITLE"}),!0)}else"guestpass-created"===i[0]?(this.guestPasses[""+i[1]]=i[2],a.set("value",i[2]),"grabLinkItem"===n&&this.selectInput(a),this.endGuestpassLoader(),this.updateEmbedCode(i[2])):"guestpass-failed"===i[0]?(s.one(".grab-link-permission-label")&&s.one(".grab-link-permission-label").set("text",this.intlMessage({intlName:"share-modal.SHARE_PUBLIC_ONLY"})),a.set("value",this.linkShareParams.shortURL),this.endGuestpassLoader(),this._onWarning(this.intlMessage({intlName:"share-modal.GUESTPASS_CREATION_FAILURE"}))):"generated-link"===i[0]&&(s.one(".grab-link-text-field").set("text",i[1]),a.set("value",i[1]),this.selectInput(a),this.endGuestpassLoader())},updateEmbedCode:function(e){var t=this.get("container"),i=t.one(".embed-code-text-field");if(i){var s=t.one(".embed-code-text-field").get("value"),a=/href=".*?"/,n='href="'+e+'"';i.set("value",s.replace(a,n)),this.linkShareDisplay.embedr.sizes.forEach(function(e){e.embedCode&&(e.embedCode=e.embedCode.replace(a,n))}),this.linkShareDisplay.embedr.sizes=this.linkShareDisplay.embedr.sizes.filter(function(e){return"o"!==e.sizeKey})}},setHighlightWidths:function(){var t,i,s,a,n=this.get("container"),r=n.one(".link-type-highlight"),l=0,o=n.one(".link-grab-type-button").getDOMNode().offsetLeft,h=e.StorageHelper.getItem("fluid-share-panel-first-selected")||"grabLinkItem";for(t=[{name:"grabLinkItem",element:n.one(".link-grab-type-button")},{name:"embedItem",element:n.one(".embed-type-button")},{name:"iframeItem",element:n.one(".iframe-type-button")},{name:"emailItem",element:n.one(".email-type-button")},{name:"bbCodeItem",element:n.one(".bbcode-type-button")}],this.highlightWidths={},a=0;a<t.length;a++)(s=t[a]).element?(l=parseInt(s.element.get("clientWidth"),10),this.highlightWidths[s.name]={width:l,left:o+"px"},o+=l+24):s.name===h&&(h="grabLinkItem");1===Object.keys(this.highlightWidths).length&&(h="grabLinkItem"),i=t.filter(function(e){return e.name===h})[0].element,r.setStyles(this.highlightWidths[h]),this._toggleLinkSelection({target:i},n)},_toggleLinkSelection:function(t,i){var s,a=i.one(".link-type-highlight"),n=t.target.ancestor(".link-type-buttons",!0).get("children").indexOf(t.target);i.one(".share-link-types").toggleClass("first-stop",0===n).toggleClass("second-stop",1===n).toggleClass("third-stop",2===n).toggleClass("fourth-stop",3===n),t.target.hasClass("link-grab-type-button")?(s=this.highlightWidths.grabLinkItem,this.selectInput(i.one(".grab-link-text-field")),e.StorageHelper.setItem("fluid-share-panel-first-selected","grabLinkItem"),e.rapidTracker.beacon(this.name,"grabLinkTabClick"),this.manageTabbables(".grab-link-only")):t.target.hasClass("embed-type-button")?(s=this.highlightWidths.embedItem,this.linkShareParams.isNonPublic||this.selectInput(i.one(".embed-code-text-field")),e.StorageHelper.setItem("fluid-share-panel-first-selected","embedItem"),e.rapidTracker.beacon(this.name,"embedTabClick")):t.target.hasClass("iframe-type-button")?(s=this.highlightWidths.iframeItem,this.selectInput(i.one(".iframe-code-text-field")),e.StorageHelper.setItem("fluid-share-panel-first-selected","iframeItem"),e.rapidTracker.beacon(this.name,"iframeTabClick")):t.target.hasClass("bbcode-type-button")?(s=this.highlightWidths.bbCodeItem,this.selectInput(i.one(".bb-code-text-field")),e.StorageHelper.setItem("fluid-share-panel-first-selected","bbCodeItem"),e.rapidTracker.beacon(this.name,"bbCodeTabClick")):t.target.hasClass("email-type-button")&&(this.appContext.getViewer().signedIn?(s=this.highlightWidths.emailItem,e.StorageHelper.setItem("fluid-share-panel-first-selected","emailItem"),e.rapidTracker.beacon(this.name,"emailTabClick")):this.fire("subviewViewEvent","confirm-sign-in"),this.manageTabbables(".email-sharing-panel")),a.setStyles(s)},_createDropdown:function(t,i,s,a,n){var r=this;n&&!n.isClosed||((n=new e.Views.FluidDroparound({appContext:this.appContext,showDropArrow:!0,hideModalOverlay:!0,classList:"over-modal",overlayClassList:"over-modal",anchorElement:t.one("."+i+" .dropdown-arrow"),observePageResize:!0,menuItems:s,forceLeft:!0,anchorOffsetHorizontal:16,closeOnResize:!0,maxHeight:280})).on("selected",function(e){n.close(),a.bind(r)(e),r.setHighlightWidths()}),n.show())},_createdDropdownForEmbedIframeBB:function(t,i){var s,r,l,o;t.target.ancestor(".embed-size-field",!0).hasClass("embed-code-size-field")?(s="embed-code-size-field",r="embedr"):t.target.ancestor(".embed-size-field",!0).hasClass("iframe-code-size-field")?(s="iframe-code-size-field",r="iframe"):t.target.ancestor(".embed-size-field",!0).hasClass("bb-code-size-field")&&(s="bb-code-size-field",r="bbCode"),l=this.linkShareDisplay[r].sizes,o=n.concat(["o"]),this._createDropdown(i,s,Object.keys(l).map(function(e){return{text:l[e].sizeStr,value:l[e].sizeKey}}).sort(function(e,t){return e.value.includes("p")&&!t.value.includes("p")?1:!e.value.includes("p")&&t.value.includes("p")?-1:o.indexOf(e.value[0])<o.indexOf(t.value[0])?-1:1}),function(t){var n;t&&t.menuItem&&(l.some(function(r){return r.sizeKey===t.menuItem.value&&(n=r.sizeKey,i.one("."+a[s]).set("value",r.embedCode),i.one("."+s).one(".embed-code-label").set("text",r.sizeStr),e.Analytics.sendClick("Embed Size: "+n,"Embed Size Change"),!0)}),e.StorageHelper.setItem("fluid-share-panel-"+r+"-default-size",n))},this.dropdowns[r])},_createGrabLinkPermissionDropdown:function(e,t){var i=this;this._createDropdown(t,"grab-link-field",this.PERMISSIONS,function(e){if(e&&e.menuItem){var s=e.menuItem.value;i._prepareRequestGuestPass.call(i,t,s,e.menuItem)}},this.dropdowns.grabLink)},_createMailPermissionDropdown:function(e,t){var i=this;this._createDropdown(t,"mail-perm-field",this.PERMISSIONS,function(e){e&&e.menuItem&&(t.one(".mail-permission-label").set("text",e.menuItem.text),i.flickrShare.guestpassStr=e.menuItem.value)},this.dropdowns.mail)},getShareByEmailPrintValue:function(){var e=this.get("container").one("#enable-email-print");return!!(this.appContext.flipper.isFlipped("enable-guest-pass-printing")&&this.guestPassParams.showOptionToEnablePrint&&this.isMine&&e)&&e.getDOMNode().checked},_onShareByEmail:function(e){var t={recipients:this.flickrShare.recipients,guestpassStr:this.flickrShare.guestpassStr,enablePrint:this.getShareByEmailPrintValue(),message:this.get("container").one(".email-message-text-field").get("value")};this.fire("subviewViewEvent","share-by-email",t)},manageTabbables:function(e){var t=this.get("container");t.all(".link-type-content:not("+e+") .tabbable").setAttribute("tabindex","-1"),t.all(e+" .tabbable").setAttribute("tabindex","0")},generateLinkSharingDisplay:function(t){var s=this,a={link:t.url,isNonPublic:t.isNonPublic},n=t.sizes?Object.keys(t.sizes):[];return n.length>0&&t.supportsEmbedr&&(a.embedr={sizes:Object.keys(t.sizes).map(function(a){return{sizeKey:a,sizeStr:s.getSizeStr(a)+" ("+t.sizes[a].width+" × "+t.sizes[a].height+")",embedCode:s.templates("fluid-share-embedr-code")({embedLink:e.url(t.embedUrl||t.url),title:t.title,farmURL:e.URLHelper.addProtocolToURL(i(t.sizes[a])),width:t.sizes[a].width,height:t.sizes[a].height,alt:t.title,displayOptions:r,showSlideshowOption:void 0!==s.linkShareParams.albumId||void 0!==s.linkShareParams.galleryId})}})}),n.length>0&&t.supportsBBCode&&(a.bbCode={sizes:Object.keys(t.sizes).map(function(a){return{sizeKey:a,sizeStr:s.getSizeStr(a)+" ("+t.sizes[a].width+" × "+t.sizes[a].height+")",embedCode:s.templates("fluid-share-bb-code")({title:t.title,farmURL:e.URLHelper.addProtocolToURL(i(t.sizes[a])),shortURL:t.shortURL,authorURL:e.url(t.authorURL),authorName:t.author})}})}),a},getSizeStr:function(e){var t="";return["sq","q"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.SQUARE"}):"t"===e?t=this.intlMessage({intlName:"common.THUMBNAIL"}):["s","n","w"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.SMALL"}):["sp","np","wp"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.SMALL_PORTRAIT"}):["m","z","c"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.MEDIUM"}):["mp","zp","cp"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.MEDIUM_PORTRAIT"}):["l","h","k"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.LARGE"}):["lp","hp","kp"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.LARGE_PORTRAIT"}):["3k","4k","5k","6k"].indexOf(e)>-1?t=this.intlMessage({intlName:"common.XLARGE"}):"o"===e&&(t=this.intlMessage({intlName:"common.ORIGINAL"})),t},regenerateGuestPass:function(e){var t=e||this.PERMISSIONS[0].value,i=this.get("container");(this.isMine&&-1===this.linkShareParams.url.indexOf("favorites")&&(this.guestpassRequired||"public"===t)||"public"!==t)&&("public"!==t&&i.one(".grab-link-privacy-reminder").removeClass("hide-reminder"),this.guestpassLoaded=!1,this.startGuestpassLoader(),this._prepareRequestGuestPass(i,t,!1))},_prepareRequestGuestPass:function(t,i,s){var a=t.one(".grab-link-text-field"),n=t.one(".grab-link-privacy-reminder"),r=this.get("container").one("#enable-share-print"),l=0;if(s&&t.one(".grab-link-permission-label").set("text",s.text),r&&r.getDOMNode().checked&&(l=1),"public"!==i||l){var o=0,h=0,d=0;"friends"===i?o=1:"family"===i&&(h=1),"family_and_friends"===i?(h=1,o=1):"private"===i&&(d=1,h=1,o=1),a.setAttribute("data-perm-level",i),"public"!==i&&n.removeClass("hide-reminder"),this.requestGuestpass(h,o,d)}else a.set("value",this.linkShareParams.shortURL),a.setAttribute("data-perm-level",i),n.addClass("hide-reminder"),this.updateEmbedCode(e.url(this.linkShareParams.embedUrl||this.linkShareParams.url)),this.endGuestpassLoader()},requestGuestpass:function(e,t,i){var s,a=this.get("container").one(".grab-link-text-field"),n=this.get("container").one("#enable-share-print"),r=0;if(n&&n.getDOMNode().checked&&(r=1),s=""+e+t+i+r,this.guestPasses[s])return a.set("value",this.guestPasses[s]),this.updateEmbedCode(this.guestPasses[s]),this.endGuestpassLoader(),void(this.guestpassLoaded=!0);var l={is_private:i,is_family:e,is_friend:t,print:r},o=this.guestPassParams.type,h=this.guestPassParams.id;"photo"===o&&(l.photo=h),"photostream"===o&&(l.photostream=h),"set"===o&&(l.set=h),this.guestpassLoaded=!1,this.startGuestpassLoader(),this.fire("subviewViewEvent","request-guestpass",s,l)},startGuestpassLoader:function(){var e=this;setTimeout(function(){if(!e.guestpassLoaded){var t=e.get("container").one(".grab-link-loader");t.setStyle("display","block"),t.addClass("show-loader"),t.removeClass("link-ready")}},50)},endGuestpassLoader:function(){var e=this.get("container").one(".grab-link-loader");this.guestpassLoaded=!0,e.removeClass("show-loader"),setTimeout(function(){this.guestpassLoaded&&e.setStyle("display","none"),e.addClass("link-ready")}.bind(this),500)},setupEmailSharing:function(){var t=this.get("container"),i=t.one(".email-recipient-text-field"),s=this.fakeInput=t.one(".fake-input"),a=this.input=this.get("container").one('[data-field="recipient"]'),n=t.one(".email-message-text-field"),r=t.one(".share-by-email"),l=this;this.focus&&(setTimeout(function(){i.focus()},100),this.focus=!1),i&&(this.to={},this.arrow=e.Node.create('<span class="ui-dialog-arrow contact-autocomplete-arrow"></span>'),i.on("focus",function(){s.addClass("focus"),""===a.get("value")?l.contacts.hide():l.contacts.search(),l._adjustInputWidth()}),i.on("blur",function(){a.ancestor(".fake-input").one(".pill")||t.one(".email-recipient-text-field").setStyle("width","inherit")}),a.on("blur",function(){var e,t=!1;(e=l.contacts.selected)&&e.email&&(t=!0,l._makePill(e,t),l.contacts.selected=null,l.get("container").one(".fake-input").insertBefore(a,l.contacts.wrapperEl)),s.removeClass("focus")}),a.on("keydown",function(e){var t,i;8===e.keyCode?(""===this.get("value")&&(i=l.get("container").all(".pill").pop())&&i.fire("remove"),setTimeout(function(){l._adjustInputWidth()},0)):(13===e.keyCode||9===e.keyCode&&!e.shiftKey||32===e.keyCode||188===e.keyCode)&&((t=l.contacts.selected)&&t.email?(e.preventDefault(),l._makePill(t),l.contacts.selected=null,l._arrangeInput()):13!==e.keyCode||l.contacts.selected||(e.preventDefault(),""===this.get("value")&&l.get("container").one('[data-field="message"]').focus()))}),a.on("keypress",function(e){var t=this.get("value");l._adjustInputWidth(t+String.fromCharCode(e.which)),l.contacts._reposition(),this.show()}),a.on("keyup",function(t){0===e.Object.size(l.to)&&""===l.input.get("value")?r.setAttribute("disabled",!0):r.removeAttribute("disabled"),8===t.keyCode&&""===this.get("value")&&l._arrangeInput()}),n.on("keydown",function(e){9!==e.keyCode||e.shiftKey||(e.preventDefault(),r.focus())}),s.delegate("click",function(e){l._arrangeInput()},".fake-input"),s.delegate("mouseover",function(e){var t=e.currentTarget,i=s.get("clientWidth"),a=(t.get("offsetLeft"),parseInt(t.getComputedStyle("width").replace("px",""),10));i-(t.get("offsetLeft")-s.get("offsetLeft"))-a-10>0?(t.addClass("not-eol"),t.removeClass("end-of-the-line")):(t.removeClass("not-eol"),t.addClass("end-of-the-line"))},".pill"),this.contacts=new e.ContactSearchBox({el:i,appContext:this.appContext,shim:"c-contact-search-shim",signedOut:!this.appContext.getViewer().signedIn,alwaysDownward:!0,DOMContainer:t.one(".share-panel-body").getDOMNode(),loadingState:this.templates(e.Balls())(),onError:function(){i.blur(),l.contacts.hide()},onShow:function(e){var t=l.get("container"),i=l.get("container").one(".contact-list");t.on("click",function(e){"INPUT"!==e.target.get("tagName")&&"block"===i.getStyle("display")&&l.contacts.hide()})},onSelect:function(e,t){e&&e.nsid&&(l._makePill(e),l._arrangeInput())},dialogOffset:function(){var e=l.fakeInput.getDOMNode().getBoundingClientRect(),t=l.input.getDOMNode().getBoundingClientRect();return e.height-t.height+10}}))},_adjustInputWidth:function(t){var i,s,a,n=this.get("container"),r=n.one(".share-by-email"),l=this;return t=t||this.input.get("value"),0===e.Object.size(this.to)&&""===t?((s=n.one(".fake-input")).removeClass("not-empty"),i=s.get("clientWidth"),""!==n.one(".email-message-text-field").get("value").trim()&&r.setAttribute("disabled",!0),this.input.setStyle("width",i-20),setTimeout(function(){l.input.focus()},10),i):((a=e.Node.create('<span class="width-check"></span>')).set("innerHTML",escape(t)),this.get("container").appendChild(a),i=a.get("clientWidth")||0,a.remove(),this.input.setStyle("width",(i||30)+5+"px"),setTimeout(function(){l.input.focus()},10),i)},_makePill:function(e,t){var i,s=e.realname||e.email,a=this.templates("share-modal-mail-pill")({value:s}),n=this.get("container"),r=n.one(".share-by-email"),l=n.one(".fake-input"),o=this,h=encodeURIComponent(s);l.addClass("not-empty"),""!==n.one(".email-message-text-field").get("value").trim()&&r.removeAttribute("disabled"),this.to[h]=e,o.completeSameEvent&&o.completeSameEvent.detach(),(i=l.insertBefore(a,this.contacts.wrapperEl)).on("remove",function(t){e.nsid?o.contacts.showInSearch(e.nsid):e.email&&!t&&(o.input.set("value",i.one("span:first-child").get("innerHTML")),o._adjustInputWidth()),delete o.to[h],i.remove(),o.flickrShare.recipients.some(function(t,i){return!!(t.nsid&&t.nsid===e.nsid||!t.nsid&&t.name&&t.name===e.name)&&(o.flickrShare.recipients.splice(i,1),!0)})}),i.delegate("click",function(e){e.stopPropagation(),i.fire("remove",!0),o.input.focus()},".remove-tag"),i.on("dblclick",function(t){t.stopPropagation();var s=o.input;s.set("value",h),o._adjustInputWidth(h),i.replace(s),i.fire("remove"),setTimeout(function(){s.focus()},10),o.contacts.search(),o.completeSameEvent=s.once("blur",function(t){s.get("value")===h&&(o._makePill(e),o.input.set("value",""),o._arrangeInput())})}),e.nsid&&this.contacts.hideFromSearch(e.nsid),this.flickrShare.recipients.push(e),this.input.set("value",""),t||(this.input.focus(),o._adjustInputWidth())},_arrangeInput:function(){var e=this.input;this.get("container").one(".fake-input").insertBefore(e,this.contacts.wrapperEl),setTimeout(function(){e.focus()},10)},_onWarning:function(t,i,s){var a=e.Node.create(this.templates("fluid-warning")({message:t,title:i})),n=e.Node.create("<div></div>"),r=this.get("container"),l=this,o=(r.get("clientWidth")+20)/2-260,h=(r.get("clientHeight")+20)/2-60;a.setStyle("width",500),a.setStyle("height",100),a.setStyle("left",o),a.setStyle("top",h),n.setStyle("left",0),n.setStyle("top",0),n.setStyle("width","100%"),n.setStyle("height","100%"),n.addClass("warning-modal"),r.append(n),n.append(a),n.on("click",function(){n.remove(!0),s&&l.fire("subviewViewEvent","closeAll")})},_updateEmbedrOptions:function(t){var i=t.target.getData("setting"),s=t.target.getDOMNode().checked,n=this.get("container"),l=e.StorageHelper.getItem("fluid-share-panel-embedr-default-size"),o=n.one(".embed-demo-container")
;r[i]=s?"true":"false",this.linkShareDisplay=this.generateLinkSharingDisplay(this.linkShareParams),this.linkShareDisplay.embedr.sizes.some(function(e){if(e.sizeKey===l)return n.one("."+a["embed-code-size-field"]).set("value",e.embedCode),n.one(".embed-code-size-field").one(".embed-code-label").set("text",e.sizeStr),!0}),"true"===r.header?o.addClass("show-header"):o.removeClass("show-header"),"true"===r.footer?o.addClass("show-footer"):o.removeClass("show-footer"),this.selectInput(n.one(".embed-code-text-field")),e.StorageHelper.setItem("embedr-options",JSON.stringify(r))},selectInput:function(e){e.getDOMNode&&(e=e.getDOMNode()),e.setSelectionRange&&e.setSelectionRange(0,999)}})},"@VERSION@",{requires:["flickr-view","promise","hermes-template-fluid-share-panel","fluid-droparound-view","hermes-template-fluid-share-embedr-code","hermes-template-fluid-share-bb-code","hermes-template-share-modal-mail-pill","hermes-template-fluid-warning","hermes-template-fluid-share-panel-error","hermes-template-fluid-share-old-html-embed-code","hermes-template-fluid-share-old-iframe-embed-code","fluid-modal-view","contact-search-box","html5-balls","overflow-helper","url-helper","storage-helper"],optionalRequires:["global-events"],langBundles:["share-modal","common"]});YUI.add("hermes-lang-share-modal_fr-fr",function(e,r){e.Intl.add("hermes/share-modal","fr-FR",{SHARE_ON_BLOGGER:["Partager sur Blogger"],SHARE_PHOTO:["Partager une photo"],SHARE_PHOTOS:["Partager des photos"],SHARE_VIDEO:["Partager la vidéo"],PLEASE_AUTHORIZE_FLICKR_TO_POST_ON_BLOGGER:["veuillez autoriser Flickr à publier des articles sur Blogger"],SHARE_ON_FACEBOOK:["Partager sur Facebook"],PLEASE_AUTHORIZE_FLICKR_TO_POST_ON_FACEBOOK:["veuillez autoriser Flickr à publier des articles sur Facebook"],SHARE_VIA_MAIL:["Partager par e-mail"],SHARE_ON_TUMBLR:["Partager sur Tumblr"],PLEASE_AUTHORIZE_FLICKR_TO_POST_ON_TUMBLR:["veuillez autoriser Flickr à publier des articles sur Tumblr"],PUBLISH_NOW:["Publier maintenant"],ADD_TO_QUEUE:["Ajouter à la file d’attente"],SAVE_AS_DRAFT:["Enregistrer comme brouillon"],SHARE_ON_TWITTER:["Partager sur Twitter"],PLEASE_AUTHORIZE_FLICKR_TO_POST_ON_TWITTER:["veuillez autoriser Flickr à publier des articles sur Twitter"],SHARE_PHOTOSTREAM:["Partager la galerie"],SHARE_ALBUM:["Partager l'album"],SHARE_FAVORITES:["Partager les favoris"],AUTHORIZE_TO_SHARE:["Vous devez autoriser Flickr à partager des photos sur ","${service}"],CONNECT_TO_SERVICE:["Connexion à ","${service}"],OK_TAKE_ME_TO_MY_SETTINGS:["OK, accéder à mes paramètres"],POST:["Publier"],SHARE:["Partager"],FRIENDS:["Amis"],FAMILY:["Famille"],SCREEN_NAME_OR_EMAIL:["Pseudo ou mail"],INCLUDE_A_MESSAGE:["Inclure un message"],SHARE_THIS_VIA:["Partager sur..."],SHARE_PREFERENCES:["préférences de partage"],GRAB_THE_LINK:["Sélectionner le lien"],SHOW_SHORT_URL:["afficher l’URL abrégée"],INCLUDE_CONTENT_MARKED_AS:["Inclure le contenu marqué comme :"],PS_ITEMS_NOT_PUBLIC:["Certains éléments de cette galerie ne sont pas publics."],HERE_IS_PS_LINK:["Voici un lien vers cette galerie. Il vous suffit de le copier et de le coller."],YOU_CAN_ADD_GUEST_PASS:['Vous pouvez ajouter un Pass invité [<a class="guest-pass-link" title="',"${title}",'" data-action="follow" href="/help/sharing/#2184">?</a>] pour que les destinataires puissent les voir.'],ADD_A_GUEST_PASS:["Ajouter un Pass invité"],GUEST_PASS_COPY:["Les Pass invité vous permettent de partager vos photos non publiques. Tout le monde, membre Flickr ou pas, peut voir vos photos publiques à tout moment. En revanche... Si vous souhaitez partager des photos marquées comme étant privées, ou concernant vos amis ou votre famille, utilisez un Pass invité. Si vous partagez des photos d’un album, vous pouvez créer un Pass invité comprenant vos photos marquées comme privées, ou concernant vos amis ou votre famille. Si vous partagez l’intégralité de votre galerie, vous pouvez créer un Pass invité comprenant des photos concernant vos amis ou votre famille (mais pas vos photos privées)."],VISIT_GUESTPASS_HISTORY:['Vous pouvez consulter l’<a href="/invite/history/guests/" data-action="follow">historique de vos Pass invité</a> à tout moment pour arrêter le Pass.'],SOMETHING_WRONG:["Une erreur est survenue.<br>Rafraîchissez l’affichage de votre navigateur et réessayez."],ERROR:["Erreur"],OK:["OK"],SHARE_GROUP:["Partager le groupe"],MESSAGE:["Message"],EMAIL:["E-mail"],SIGN_IN_TO_EMAIL:["Vous devez être connecté pour partager une photo. Connectez-vous et réessayez."],LINK_ACCOUNT:["Lier le compte"],ACCOUNT_SETTINGS:["Paramètres de compte"],AUTHORIZE_FLICKR:["Autoriser Flickr à utiliser votre compte à la page Paramètres de compte."],COPY_TO_CLIPBOARD:["Appuyez sur Ctrl+C (Windows) ou Commande+C (Mac) pour copier ce lien après l’avoir sélectionné"],HTML_EMBED:["HTML imbriqué"],EMAIL_BODY_PHOTOS:["${username}"," a partagé ",{type:"plural",valueName:"count",options:{one:"${#} photos",other:"${#} photo"}}," avec vous."],EMAIL_BODY_ALBUM:["${username}"," a partagé un album avec vous."],EMAIL_BODY_PHOTOSTREAM:["${username}","ont partagé leur galerie photos avec vous."],SHARE_PHOTOS_TO:[{type:"plural",valueName:"count",options:{one:"Partager ${#} photo sur :",other:"Partager ${#} photos sur :"}}],SHARE_VIDEO_TO:[{type:"plural",valueName:"count",options:{one:"Partagez ${#} vidéo avec :",other:"Partagez ${#} vidéos avec :"}}],SHARE_PHOTOSTREAM_TO:["Partager la galerie sur :"],SHARE_ALBUM_TO:["Partager l'album sur :"],SHARE_GALLERY_TO:["Partagez l'expo sur :"],SHARE_EXPLORE_TO:["Partager la page Explorez sur :"],SHARE_SEARCH_TO:["Partager les résultats de la recherche sur :"],SHARE_FAVES_TO:["Partager les favoris sur :"],SHARE_ALBUMS_TO:["Partager les albums sur :"],SHARE_GROUP_TO:["Partager le groupe sur :"],FACEBOOK:["Facebook"],TUMBLR:["Tumblr"],TWITTER:["Twitter"],PINTEREST:["Pinterest"],MAIL:["Mail"],EMBED:["HTML imbriqué"],EMBED_SIMPLE:["Imbriquer"],HTML:["HTML"],GRAB_LINK:["Utiliser le lien"],BBCODE:["BBCode"],VIA_FLICKR:["Via Flickr :"],SHARE_PUBLIC_ONLY:["Photos publiques uniquement"],SHARE_FRIENDS:["Inclure les photos portant la marque Amis"],SHARE_FAMILY:["Inclure les photos portant la marque Famille"],SHARE_FAMILY_AND_FRIENDS:["Inclure les photos portant la marque Famille et Amis"],SHARE_FRIENDS_AND_FAMILY:["Inclure les photos portant les marques Amis et Famille"],SHARE_PRIVATE:["Toutes les photos, publiques et privées"],SHARING_DISABLED:["Le partage est désactivé"],ON_FLICKR:["sur Flickr"],PHOTO_PRIVATE_MESSAGE:['Cette photo est privée. Un Passe invité [<a target="_blank" href="/help/sharing/">?</a>] sera ajouté pour que les destinataires soient autorisés à la visionner.'],PHOTO_FRIENDS_MESSAGE:['Cette photo n\'est visible que par vos amis. Un Passe invité [<a target="_blank" href="/help/sharing/">?</a>] sera ajouté pour que les destinataires soient autorisés à la visionner.'],PHOTO_FAMILY_MESSAGE:['Cette photo n\'est visible que par votre famille. Un Passe invité [<a target="_blank" href="/help/sharing/">?</a>] sera ajouté pour que les destinataires soient autorisés à la visionner.'],PHOTO_FAMILY_FRIENDS_MESSAGE:['Cette photo n\'est visible que par vos amis et famille. Un Passe invité [<a target="_blank" href="/help/sharing/">?</a>] sera ajouté pour que les destinataires soient autorisés à la visionner.'],PHOTO_CAMERAROLL_MESSAGE:["Toutes les photos partagées seront consultables par les destinataires, quel que soit le niveau de confidentialité."],GUESTPASS_CREATION_FAILURE:["Une erreur s'est produite lors de la génération du lien de partage.  Veuillez réessayer."],CONTACT_SEARCH_ERROR:["Une erreur s'est produite lors de l'ajout d'un destinataire. Veuillez réessayer."],FLICKR_SHARE_ERROR:["Une erreur s'est produite lors du partage sur Flickr. Veuillez réessayer."],FLICKR_SHARE_SUCCESS:["Vos éléments ont été partagés !"],FLICKR_SHARE_SUCCESS_TITLE:["Réussite"],CLICK_GENERATE_LINK:["Cliquez pour générer un lien partageable"],FLICKR_SHARE:["Partager"],COPY_MAC:["Sélectionnez ce lien, puis appuyez sur Commande+C pour le copier"],COPY_PC:["Sélectionnez ce lien, puis appuyez sur Ctrl+C pour le copier"],CANCEL_SHARE_BECAUSE_ERROR:[{type:"plural",valueName:"photoCount",options:{one:"Cette photo ne peut pas être partagée. Veuillez réessayer ultérieurement.",other:"Ces photos ne peuvent pas être partagées. Veuillez réessayer ultérieurement."}}],LINK_PRIVACY_REMINDER:[{type:"plural",valueName:"photoCount",options:{one:"La photo privée de cette sélection restera privée. Seules les personnes avec lesquelles vous partagez ce lien pourront la voir.",other:"Les photos privées de cette sélection resteront privées. Seules les personnes avec lesquelles vous partagez ce lien pourront les voir."}}],PHOTO_PAGE_PRIVACY_WARNING:["Cette photo restera privée. Seules les personnes avec lesquelles vous partagez ce lien pourront la voir."],CAMERAROLL_PRIVACY_WARNING:[{type:"plural",valueName:"photoCount",options:{one:"Cette photo restera privée. Seules les personnes avec lesquelles vous partagez ce lien pourront la voir.",other:"Les photos privées de cette sélection resteront privées. Seules les personnes avec lesquelles vous partagez ce lien pourront les voir."}}],ALBUM_PRIVACY_WARNING:[{type:"plural",valueName:"photoCount",options:{one:"La photo privée de cet album restera privée. Seules les personnes avec lesquelles vous partagez ce lien pourront les voir.",other:"Les photos privées de cet album resteront privées. Seules les personnes avec lesquelles vous partagez ce lien pourront les voir."}}],PHOTOSTREAM_PRIVACY_WARNING:[{type:"plural",valueName:"photoCount",options:{one:"La photo privée de cette galerie restera privée. Seules les personnes avec lesquelles vous partagez ce lien pourront les voir.",other:"Les photos privées de cette galerie resteront privées. Seules les personnes avec lesquelles vous partagez ce lien pourront les voir."}}],CANCEL_SHARE_BECAUSE_RESTRICTED:["Désolé ! Vous ne pouvez pas partager des photos restreintes."],NO_SHAREABLE_ITEMS:["Aucun élément disponible à partager."],CANT_SHARE_PRIVATE_GROUP_MESSAGE:['Les groupes privés peuvent uniquement être consultés par les membres de ces groupes. <a data-action="follow" href="',"${inviteURL}",'">Invitez des amis</a> à rejoindre le groupe si vous souhaitez le partager.'],CANT_SHARE_PRIVATE_GROUP_TITLE:["Partager un groupe privé"],EMBEDR_OPTION_HEADER:["En-tête"],EMBEDR_OPTION_FOOTER:["Bas de page"],EMBEDR_OPTION_TRUNCATE:["Tronquer"],EMBEDR_OPTION_SLIDESHOW:["Diaporama"],EMBEDR_CHANGE_PRIVACY_WARNING:["Vous essayez d’imbriquer une de vos photos privées. Si vous souhaitez vraiment imbriquer cette photo, vous pouvez la rendre publique en sélectionnant Public dans le menu Confidentialité au bas de cette page."],ALBUM_DOWNLOAD_ACCESS_YOU:[{type:"plural",valueName:"photoCount",options:{one:"Vous êtes la seule personne à pouvoir télécharger cette photo.",other:"Vous êtes la seule personne à pouvoir télécharger ces photos."}}],ALBUM_DOWNLOAD_ACCESS_FF:[{type:"plural",valueName:"photoCount",options:{one:"Vos amis et les membres de votre famille sont les seules personnes à pouvoir télécharger cette photo.",other:"Vos amis et les membres de votre famille sont les seules personnes à pouvoir télécharger ces photos."}}],ALBUM_DOWNLOAD_ACCESS_FOLLOWING:[{type:"plural",valueName:"photoCount",options:{one:"Les personnes que vous suivez sont les seules à pouvoir télécharger cette photo.",other:"Les personnes que vous suivez sont les seules à pouvoir télécharger ces photos."}}],ALBUM_DOWNLOAD_ACCESS_MEMBERS:[{type:"plural",valueName:"photoCount",options:{one:"Les membres Flickr sont les seules personnes à pouvoir télécharger cette photo.",other:"Les membres Flickr sont les seules personnes à pouvoir télécharger ces photos."}}],ALBUM_DOWNLOAD_ACCESS_EVERYONE:[{type:"plural",valueName:"photoCount",options:{one:"Tout le monde peut télécharger cette photo.",other:"Tout le monde peut télécharger ces photos."}}],CHANGE_DOWNLOAD_PREF:["(<a href='","${url}","'>Changez les préférences de téléchargement</a>)"],EMBED_WITH_GUESTPASS:["Intégrez cette photo avec un pass invité"],ENABLE_GUEST_PASS_PRINTING_PUBLIC:["Allow viewers to buy prints via a guest pass"],ENABLE_GUEST_PASS_PRINTING:["Allow viewers to buy prints"],MANAGE_GUEST_PASSES:["Manage your guest passes"]})},"@VERSION@",{requires:["intl"]});YUI.add("signin-helper",function(e){function n(n,o){e.FlickrStorage.store(n,o)}function o(n,o){var i,t;o&&o.withPopup?(i=e.config.win.open(r(o),"_blank","height=650,resizable=1,scrollbars=1,location=yes"),t=setInterval(function(){i.closed&&(clearInterval(t),window.location.reload())},1e3)):e.config.win.location=r(o)}function r(n){(n=n||{}).closeWhenDone&&(n.postLoginUrl=e.url("/photo_grease_postlogin.gne",{protocol:!1}));var o=n.postLoginUrl||e.config.win.location.href;return(n.url||e.url("/signin/",{protocol:!1}))+"?redir="+encodeURIComponent(o)}function i(n,o){var r=(o=o||{}).postLoginUrl||e.config.win.location.href,i=o.url||e.url("/signup/",{protocol:!1});e.config.win.location=i+"?redir="+encodeURIComponent(r)}e.FlickrStorage={_storageKey:"flickrStorage",store:function(n,o){try{var r=[];e.StorageHelper.hasEntries(this._storageKey)&&(r=this.retrieve()),r.push({key:n,value:o}),e.StorageHelper.setItem(this._storageKey,JSON.stringify(r))}catch(e){}},retrieve:function(){var n={};try{n=JSON.parse(e.StorageHelper.getItem(this._storageKey))}catch(e){}return n},remove:function(){try{e.StorageHelper.remove(this._storageKey)}catch(e){}},hasEntries:function(){return e.StorageHelper.hasEntries(this._storageKey)}},e.SigninHelper={savePreLoginAction:n,addPendingFave:function(e,r){n("fave",e),o(0,r)},addPendingComment:function(e,n){o(0,n)},addPendingShare:function(e,r){n("share",e),o(0,r)},addPendingFollow:function(e,r){n("follow",e),o(0,r)},addPendingJoinGroup:function(e,r){n("joingroup",e),o(0,r)},addPendingDownload:function(e,r){n("download",e),o(0,r)},checkPendingQueue:function(n){var o,r,i=[];if(n){if(e.FlickrStorage.hasEntries()){o=e.FlickrStorage.retrieve();for(r in o)(function(e,n){var o=n.key,r=n.value;switch(o){case"fave":return(function(e,n){var o=n.id;e.getModelRegistry("photo-engagement-models").then(function(e){var n=e.proxy(o);n.registry.addAsFave(o)&&n.remoteUpdate()})})(e,r),!0;case"share":return!1}})(n,o[r])||i.push(o[r])}return e.FlickrStorage.remove(),i}},_redirectToSignin:o,_redirectToSignUp:i,_getSigninUrl:r,signUpPendingFave:function(e,o){n("fave",e),i(0,o)},signUpPendingComment:function(e,n){i(0,n)},signUpPendingFollow:function(e,o){n("follow",e),i(0,o)},signUpPendingJoinGroup:function(e,o){n("joingroup",e),i(0,o)},signUpPendingDownload:function(e,o){n("download",e),i(0,o)}}},"@VERSION@",{requires:["url","storage-helper"]});YUI.add("fluid-share-view",function(e,r){var t=require("hermes-core/flog")(r),a={shareRedirectURL:e.url("/window_close.html"),css:{shareBtn:"fluid-share-button",networkClasses:{twitter:{canShare:!1,className:"twitter-link",serviceId:9},facebook:{canShare:!1,className:"facebook-link",serviceId:128},tumblr:{canShare:!1,className:"tumblr-link",serviceId:12},pinterest:{canShare:!1,className:"pinterest-link",serviceId:132},flickr:{canShare:!1,className:"flickr-link",serviceId:130}}}};a.networks={facebook:{clientId:e.config.flickr.facebook.client_id,shareUrl:"https://www.facebook.com/dialog/share?app_id="+e.config.flickr.facebook.client_id+"&display=popup&redirect_uri="+encodeURIComponent(a.shareRedirectURL)+"&href="},twitter:{shareUrl:"https://twitter.com/intent/tweet?text={{tweetText}}&url={{linkToShare}}",hashTags:"#flickr"},tumblr:{shareUrl:"https://www.tumblr.com/widgets/share/tool?caption={{tumblrCaption}}&tags={{tags}}&url={{linkToShare}}"},pinterest:{shareUrl:"https://pinterest.com/pin/create/bookmarklet/?media={{displayPhotoURL}}&url={{linkToShare}}&description={{description}}"},flickr:{apiCall:"flickr.sharing.post"}},e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this.extraModalClasses=this.extraModalClasses||"","en-us"===this.appContext.lang.toLowerCase()?this.isEnglishLang=!0:this.isEnglishLang=!1,this.errorTitle=this.intlMessage({intlName:"common.OOPS"}),this.errorMessage=this.intlMessage({intlName:"share-modal.NO_SHAREABLE_ITEMS"}),this.removeOverlayOnClose=e.removeOverlayOnClose,this},loadState:function(){return e.Promise.resolve()},buildContainer:function(e){return e=e||{},this.setContainerWithTemplate("fluid-share",e),this},activate:function(){var r=this.get("container"),t="."+a.css.shareBtn,i=r.one(t);return!i||!this.isEnglish&&this.isDisabled||this.registerEventHandler(r.delegate(["click","keydown"],function(r){"click"!==r.type&&13!==r.keyCode||(r.preventDefault(),e.rapidTracker.beacon(this.subClassName,"shareButtonClick"),this.getItemCount().then(function(r){e.rapidTracker.beacon(this.subClassName,"shareButtonClickCount",{count:r})}.bind(this)),this.prepareModal(i))},t,this)),this},prepareModal:function(r){if(!this.shouldCancelModal())return this.getItemCount().then(function(t){return this.isDisabled?e.Promise.resolve(this.showErrorModal()):e.Promise.resolve(this.showModal(r,t,this.removeOverlayOnClose))}.bind(this)).catch(function(e){t.error({err:e})})},showModal:function(r,t,i){var s,n=this,o=this.getIsMine(),l=a.css.networkClasses,c=n.getTitleIntlKey(),h={intlName:"share-modal."+c};return"SHARE_PHOTOS_TO"!==c&&"SHARE_VIDEO_TO"!==c||(h.count=t),(s=new e.Views.FluidModal({appContext:this.appContext,dismissOnOverlayClick:!0,noScroll:!0,hideModalOverlay:!1,maxHeight:!1,showFooter:!1,title:n.intlMessage(h),classList:"modal-restyle "+n.extraModalClasses,width:560,subview:new e.Views["fluid-share-panel-view"]({appContext:n.appContext,networkClasses:l,linkShareParams:this.prepareLinkShareParameters(),guestPassParams:this.getGuestPassParams(),emailShareParams:this.prepareFlickrShareParameters(),isMine:o,shareItemCount:t,signedOutSharingPerms:this.getSignedOutSharingPerms(),canVr:this.get("canVr")}),removeOverlayOnClose:i})).registerEventHandler(s.get("container").delegate(["click","keydown"],function(e){"click"!==e.type&&13!==e.keyCode||(e.preventDefault(),e.target.ancestor("."+l.facebook.className,!0)?n.preProcessShare(n.prepareFacebookShareParameters,n.shareToFacebook):e.target.ancestor("."+l.twitter.className,!0)?n.preProcessShare(n.prepareTwitterShareParameters,n.shareToTwitter):e.target.ancestor("."+l.tumblr.className,!0)?n.preProcessShare(n.prepareTumblrShareParameters,n.shareToTumblr):e.target.ancestor("."+l.pinterest.className,!0)&&n.preProcessShare(n.preparePinterestShareParameters,n.shareToPinterest))},".share-link.sharing-type-enabled")),s.on("share-by-email",function(r){var t=e.merge(n.prepareFlickrShareParameters(),r);n.shareToFlickr(s,t)}),s.on("done-sharing",function(r){s.close(),n.guestPassURLs={},e.rapidTracker.beacon(this.subClassName,"doneSharingClick")}),s.on("request-guestpass",function(e,r,t){n.requestGuestpass(s,r,t,!0)}),s.on("generate-link",function(){n.generateLink().then(function(e){s.fire("parentViewEvent","generated-link",e)})}),s.on("activated",function(){s.get("subview").cancel&&s.get("container").one(".title").setHTML(n.intlMessage({intlName:"common.OOPS"})),s.reposition()}),s.on("guestpass-required",function(){n.guestpassRequired=!0}),s.on("confirm-sign-in",function(){s.close();var r=new e.Views.FluidModal({appContext:n.appContext,title:n.intlMessage({intlName:"common.OOPS"}),message:n.intlMessage({intlName:"share-modal.SIGN_IN_TO_EMAIL"}),actionButtonLabel:n.intlMessage({intlName:"common.OK"}),classList:"sharing-sign-out-modal",showCancelButton:!0});r.on("actionClick",function(){e.StorageHelper.setItem("signedOutEmailSharing",new Date),e.SigninHelper.addPendingShare({shareType:"email"})}),setTimeout(function(){r.show()},10)}),s.on("close",function(){n.fire("sharePresentationClose"),n.guestPassURLs={},e.rapidTracker.beacon(n.name,"shareModalCancelClick")}),s.on("closeAll",function(){n.fire("sharePresentationClose"),s.close(),n.guestPassURLs={}}),s.show(),this.sharePresentation=s,s},showErrorModal:function(){var r=new e.Views.FluidModal({appContext:this.appContext,dismissOnOverlayClick:!0,showCancelButton:!1,noScroll:!0,hideModalOverlay:!1,showFooter:!0,title:this.errorTitle,message:this.errorMessage});return r.show(),r},prepareFacebookShareParameters:function(){return{url:"",count:1}},prepareTwitterShareParameters:function(){return{shortURL:"",url:"",title:"",count:1}},prepareTumblrShareParameters:function(){return{title:"",authorURL:"",ownerName:"",description:"",displayPhotoURL:"",url:"",count:1}},preparePinterestShareParameters:function(){return{title:"",description:"",displayPhotoURL:"",shortURL:"",url:"",count:1}},prepareFlickrShareParameters:function(){return{modelName:"",modelId:"",title:"",url:"",count:1}},prepareLinkShareParameters:function(){return{sizes:{},url:"",title:"",author:"",authorURL:"",shortURL:"",supportsEmbedr:!1,supportsBBCode:!1,privacyWarningString:"",generateLink:!1}},getTitleIntlKey:function(){return"SHARE_PHOTOS_TO"},getItemCount:function(){return e.Promise.resolve(1)},getIsMine:function(){return!1},getGuestPassParams:function(){return{type:null,id:null,contentMarkedFriends:!0,contentMarkedFamily:!0,contentMarkedFriendFamily:!0,contentMarkedPublic:!0,canSharePrivate:!1,sharingEntirelyNotPublic:!1,multipleItems:!1,nonPublicWarning:null,shareToAll:!1,showGuestPassDropdown:!1,shareToSpecific:null}},getSignedOutSharingPerms:function(){return{facebook:{canShare:!0},twitter:{canShare:!0},tumblr:{canShare:!0},pinterest:{canShare:!0},flickr:{canShare:!1}}},shouldCancelModal:function(){return!1},shareToFacebook:function(r,i){if(!r.url)return t.error("Error sharing to Facebook.  Missing url.");var s,n,o,l,c,h=encodeURIComponent(e.url(r.url)),u=this.guestPassURLs;this.guestpassRequired&&u&&(n=u[100],o=u["010"],l=u[110],c=u[111],o&&(h=o),n&&(h=n),l&&(h=l),c&&(h=c)),s=a.networks.facebook.shareUrl+h,e.rapidTracker.beacon(this.get("parentViewName"),"shareNetworkClick",{type:"facebook",count:r.count||1}),i?i.location.replace(s):i=this.createSharePopup(s),this.trackShareCompletion(i)},shareToTwitter:function(r,i){if(void 0===r.url||null===r.url)return t.error("Error sharing to Twitter.  Missing url.");if(!r.title)return t.error("Error sharing to Twitter.  Missing title.");var s,n,o,l,c=r.title;n=""===r.url?"":encodeURIComponent(r.url),(l=c+" "+a.networks.twitter.hashTags).length+n.length>140&&(o=l.length+n.length-140,l=c.substring(0,c.length-(o+1))+"… "+a.networks.twitter.hashTags),s=a.networks.twitter.shareUrl.replace("{{tweetText}}",encodeURIComponent(l)).replace("{{linkToShare}}",n),i?i.location.replace(s):i=this.createSharePopup(s),e.rapidTracker.beacon(this.get("parentViewName"),"shareNetworkClick",{type:"twitter",count:r.count||1}),this.trackShareCompletion(i)},shareToTumblr:function(r,i){if(!r.title)return t.error("Error sharing to Tumblr.  Missing title.");if(!r.displayPhotoURL)return t.error("Error sharing to Tumblr.  Missing displayPhotoURL.");var s,n,o,l,c,h=r.title,u=r.tags||"",p=r.description,d=e.URLHelper.addProtocolToURL(r.displayPhotoURL),m=r.isPhotoPage,g=a.networks.tumblr.shareUrl;m&&this.appContext.flipper.isFlipped("enable-tumblr-embed-share")||(g+="&shareSource=legacy&posttype=photo&content={{displayPhotoURL}}&clickthroughUrl={{linkToShare}}"),r.authorURL&&(n=e.url(r.authorURL)),r.ownerName&&(o=r.ownerName),l=0===r.url.indexOf("https://")?r.url:0===r.url.indexOf("//")?e.URLHelper.addProtocolToURL(r.url):e.url(r.url),s=this.templates("fluid-share-tumblr-post")({title:h,ownerURL:n,ownerName:o,description:p,linkToShare:l}),c=g.replace("{{displayPhotoURL}}",encodeURIComponent(d)).replace("{{tumblrCaption}}",encodeURIComponent(s)).replace(/{{linkToShare}}/g,encodeURIComponent(l)).replace("{{tags}}",encodeURIComponent(u)),e.rapidTracker.beacon(this.get("parentViewName"),"shareNetworkClick",{type:"tumblr",count:r.count||1}),i?i.location.replace(c):i=this.createSharePopup(c,!0)},shareToPinterest:function(r,i){if(!r.title)return t.error("Error sharing to Pinterest.  Missing title.");if(!r.displayPhotoURL)return t.error("Error sharing to Pinterest.  Missing displayPhotoURL.");if(!r.url)return t.error("Error sharing to Pinterest.  Missing url.");if(!r.shortURL)return t.error("Error sharing to Pinterest.  Missing shortURL.");var s,n,o,l=e.Handlebars.helpers.stripTags(r.description)||"",c=r.shortURL,h=r.title,u=e.URLHelper.addProtocolToURL(r.displayPhotoURL);n=encodeURIComponent(e.url(r.url)),o=""!==l.trim()?c+" | "+h+" | "+l:c+" | "+h,u=u.replace("https:","http:"),n=n.replace("https:","http:"),s=a.networks.pinterest.shareUrl.replace("{{displayPhotoURL}}",encodeURIComponent(u)).replace("{{description}}",encodeURIComponent(o)).replace("{{linkToShare}}",n),e.rapidTracker.beacon(this.get("parentViewName"),"shareNetworkClick",{type:"pinterest",count:r.count||1}),i?i.location.replace(s):i=this.createSharePopup(s,!0)},shareToFlickr:function(r,i){if(!i.recipients)return t.error("Error sharing to Flickr.  Missing recipients.");if(!i.url)return t.error("Error sharing to Flickr.  Missing url.");if(!i.modelName)return t.error("Error sharing to Flickr.  Missing modelName.");if(!i.modelId)return t.error("Error sharing to Flickr.  Missing modelId.");var s,n,o=i.modelName,l=i.modelId,c=i.recipients,h=i.message||"",u=i.guestpassStr||"public",p=i.enablePrint||!1,d={},m=[],g=[];encodeURIComponent(e.url(i.url)),"share_code"===o?d[o]=l:d[o+"_id"]=l,d.service_type_id="130",d.owner_id=this.appContext.getViewer().nsid,"public"!==u&&("friends"!==u&&"family_and_friends"!==u||(d.guestpass_friends="1"),"family"!==u&&"family_and_friends"!==u||(d.guestpass_family="1"),"private"===u&&(d.guestpass_private="1",d.guestpass_friends="1",d.guestpass_family="1")),p&&(d.guestpass_print=1);for(s in c)(n=c[s]||{}).email?m.push(n.email):n.nsid&&g.push(n.nsid);d.to_flickr=g.join(","),d.to_email=m.join(","),d.message=e.flutil.escapeInput(h),e.rapidTracker.beacon(this.get("parentViewName"),"shareNetworkClick",{type:"flickr",count:i.count||1,flkcnt:g.length,emailcnt:m.length});var f=e.StorageHelper.getItem("signedOutEmailSharing");if(f){var k;try{(k=e.moment(f)).isValid()&&(new e.moment).diff(k,"hours")<2&&(e.rapidTracker.beacon(this.get("parentViewName"),"signedOutEmailShare",{count:i.count||1}),e.StorageHelper.remove("signedOutEmailSharing"))}catch(e){}}if(!a.networks)throw new Error("Missing sharing api configuration.");this.appContext.callAPI(a.networks.flickr.apiCall,d).then(function(){r&&r.fire("parentViewEvent","flickr-share-success")},function(e){r&&r.fire("parentViewEvent","flickr-share-error")})},generateLink:function(){var r=this;return this.onBeforeShare().then(function(e){return e},function(t){r.sharePresentation.fire("closeAll"),setTimeout(function(){new e.Views.FluidModal({appContext:r.appContext,title:r.intlMessage({intlName:"common.OOPS"}),message:r.intlMessage({intlName:"share-modal.CANCEL_SHARE_BECAUSE_ERROR",photoCount:r.getGuestPassParams.multipleItems?10:1}),actionButtonLabel:r.intlMessage({intlName:"common.OK"}),classList:"sharing-failure-modal",showCancelButton:!1}).show()},10)})},preProcessShare:function(e,r){var a=this;if(this.onBeforeShare){var i=this.createSharePopup("",!0);try{i.document.body.innerHTML=a.templates("fluid-share-loading-state")()}catch(e){18===e.code&&(i.close(),(i=this.createSharePopup("",!0)).document.body.innerHTML=a.templates("fluid-share-loading-state")())}this.onBeforeShare().then(function(s){var n;try{n=e.call(a)}catch(e){t.error("Error getting share parameters",{err:e})}r.call(a,n,i)})}else{var s;try{s=e.call(a)}catch(e){t.error("Error getting share parameters",{err:e})}r.call(a,s)}},trackShareCompletion:function(r){var a=function(i){if(i.source===r)if(i.origin===e.url("/")&&"Window closed"===i.data)t.log("Closing Facebook window."),e.rapidTracker.beacon(this.get("parentViewName"),"photoSharedToFacebook"),e.config.win.removeEventListener("message",a,!1);else if(i.origin===e.url("/")&&0===i.data.indexOf("share failure"))t.error("Got Facebook error",{data:i.data}),e.config.win.removeEventListener("message",a,!1);else if("https://twitter.com"===i.origin&&"__ready__"!==i.data)try{t.log("Tracking share completion",{data:i.data}),"tweet"===JSON.parse(i.data).params[0]&&i.returnValue&&(e.rapidTracker.beacon(this.get("parentViewName"),"photoSharedToTwitter"),e.config.win.removeEventListener("message",a,!1))}catch(e){t.error("Error tracking share completion",{err:e})}};e.config.win.addEventListener("message",a,!1)},createSharePopup:function(r,t){var a={},i="",s="nativeShare"+(new Date).getTime();return a.width=t?950:640,a.height=480,a.top=(e.config.win.screen.height-a.height)/2,a.left=(e.config.win.screen.width-a.width)/2,e.Object.each(a,function(e,r){i+=r+"="+e+","}),i=i.slice(0,-1),e.config.win.open(r,s,i)},requestGuestpass:function(e,r,t,a){var i=this;this.guestPassURLs||(this.guestPassURLs={}),this.guestPassURLs[r]?e.fire("parentViewEvent","guestpass-created",r,this.guestPassURLs[r]):this.appContext.callAPI("flickr.sharing.createGuestpass",t).then(function(t){if(!t||!t.guestpass||!t.guestpass.url)throw new Error("No guestpass returned");i.guestPassURLs[r]=t.guestpass.url,e.fire("parentViewEvent","guestpass-created",r,i.guestPassURLs[r])},function(s){a?i.requestGuestpass(e,r,t):e.fire("parentViewEvent","guestpass-failed",s)})}},{ATTRS:{parentViewName:{value:""}}})},"@VERSION@",{requires:["flickr-view","flickr-promise","fluid-modal-view","hermes-template-fluid-share","hermes-template-fluid-share-tumblr-post","hermes-template-fluid-share-loading-state","fluid-share-panel-view","url","flutil","url-helper","signin-helper","handlebars-helpers"],optionalRequires:["fluid"],langBundles:["share-modal","common"]});YUI.add("embed-size-helper",function(h){h.EmbedSizeHelper={getSizes:function(h){var i={c:{width:800,height:600},h:{width:1600,height:1200},l:{width:1024,height:768},m:{width:500,height:375},n:{width:320,height:240},w:{width:400,height:300},z:{width:640,height:480},cp:{width:600,height:800},hp:{width:1200,height:1600},lp:{width:768,height:1024},mp:{width:375,height:500},np:{width:240,height:320},wp:{width:300,height:400},zp:{width:480,height:640}};return Object.keys(i).map(function(t){i[t].url=h.getSizeToFit({width:i[t].width,height:i[t].height}).url}),i}}},"@VERSION@");
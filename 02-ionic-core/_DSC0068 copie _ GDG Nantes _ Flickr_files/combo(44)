YUI.add("scrollable-comment-list-view",function(e,t){var s=require("hermes-core/flog")(t);e.namespace("Views")[this.name]=e.Base.create(this.name,e.Views["comment-list-view"],[],{langBundles:this.details.langBundles,initializer:function(e){this.constructor.superclass.initializer.call(this,e)},loadState:function(){var e=this;return e.appContext.getModel(e.modelConfig.listRegistryName,{id:this.modelConfig.modelId}).then(function(t){e.commentListModel=t}).catch(function(e){throw s.error("Error getting comment list info",{err:e}),e})},buildContainer:function(){this.setContainerWithTemplate("scrollable-comment-list-view",this.params)},activate:function(){var e=this.get("container");this.listContainerNode=e.one(".comment-list-container"),this.scrollableEl=this.listContainerNode.getDOMNode(),this.registerEventHandler(this.commentListModel.on("valuesChanged",this.handleCommentListChange.bind(this),!0)),this.constructor.superclass.activate.call(this)},handleCommentListChange:function(e){0===e.comments.newVal.getList().length?this.showNoCommentsMessage():this.listContainerNode.removeClass("no-comments")},showNoCommentsMessage:function(){var e=this;this.listContainerNode.addClass("no-comments"),setTimeout(function(){e.fire("subviewViewEvent",{eventName:"emptyCommentContainer"})},300)},getNumOfComments:function(){return this.commentListModel.getValue(this.modelConfig.collectionName).getList().length},setLoading:function(e){this.isLoading=e,this.listContainerNode.toggleClass("loading",e)},handleLoadCommentsComplete:function(){this.listContainerNode.removeClass("loading"),0===this.getNumOfComments()&&this.showNoCommentsMessage(),this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight,this.registerEventHandler(this.listContainerNode.on("scroll",this.handleCommentsScroll.bind(this)))},appendNewComment:function(e){0===this.getNumOfComments()&&this.listContainerNode.removeClass("no-comments"),this.constructor.superclass.appendNewComment.call(this,e)},handleCommentsScroll:function(e){!this.isFetchingComments&&this.scrollableEl.scrollTop<=0&&this.getMoreComments()},showCommentLoading:function(e){e?this.showBalls(!1):this.hideBalls()},showCommentAddLoading:function(e){e?(this.showBalls(!0),this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight):this.hideBalls()},handleCommentViewAppended:function(e){this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight},updateComments:function(t){return t?this.prependComments(t):e.Promise.resolve()},prependComments:function(t){var s=this,i=[],n=[];return t.forEach(function(t){var o=t.toJSON(),l=Object.assign(o,{appContext:s.appContext,showPermalink:s.commentsViewHelper.config.commentListConfig.showPermalinks});l.isSubjectOwner=s.commentsViewHelper.commentsObj.isSubjectOwner;var m=new e.Views["comment-item-view"](l),r=m.initialize(l).then(function(){m.activate()});n.push(m),i.push(r)}),e.Promise.all(i).then(function(){s.prependCommentViewsToDom(n)})},prependCommentViewsToDom:function(t){var s,i=this,n=this.scrollableEl,o=n.scrollHeight,l=n.scrollTop;t.forEach(function(t){(s=e.Node.create('<li class="comment-list-item"></li>')).append(t.get("container")),i.commentsListNode.prepend(s)}),this.commentsViewHelper.commentsObj.flimojiParser.emojifyTarget({inputElements:["["+e.config.flickr.emojis.parserAttr+"]"],useSprites:!1,iconsPath:e.config.flickr.urls.assetRoot+"/images/joypixels",container:this.get("container").getDOMNode()}),n.scrollTop=n.scrollHeight-o+l}})},"@VERSION@",{requires:["flickr-view","comment-list-view","hermes-template-scrollable-comment-list-view"],langBundles:["common","comments"]});YUI.add("hermes-template-standard-comment-list-view",function(e,a){var t=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,a,t,n,l){var s,r=null!=a?a:{},i=t.helperMissing,o=e.escapeExpression;return'<div class="comment-list-container loading">\n\t<a role="button" class="load-more-button">'+o("function"==typeof(s=null!=(s=t.loadMoreText||(null!=a?a.loadMoreText:a))?s:i)?s.call(r,{name:"loadMoreText",hash:{},data:l}):s)+'</a>\n\t<ol class="comment-list">\n\t</ol>\n\t<div class="loading-text">'+o((t.intlMessage||a&&a.intlMessage||i).call(r,{name:"intlMessage",hash:{intlName:"comments.LOADING_COMMENTS"},data:l}))+"</div>\n</div>"},useData:!0}),n={};e.Array.each([],function(a){var t=e.Template.get("hermes/"+a);t&&(n[a]=t)}),e.Template.register("hermes/standard-comment-list-view",function(a,l){return l=l||{},l.partials=l.partials?e.merge(n,l.partials):n,t(a,l)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("standard-comment-list-view",function(e,t){require("hermes-core/flog")(t);e.namespace("Views")[this.name]=e.Base.create(this.name,e.Views["comment-list-view"],[],{langBundles:this.details.langBundles,initializer:function(e){this.constructor.superclass.initializer.call(this,e)},buildContainer:function(){this.setContainerWithTemplate("standard-comment-list-view",this.params)},activate:function(){var e=this.get("container");this.listContainerNode=e.one(".comment-list-container"),this.loadMoreButton=e.one(".load-more-button"),this.registerEventHandler(this.loadMoreButton.on("click",this.handleLoadMoreClick.bind(this))),this.constructor.superclass.activate.call(this)},setLoading:function(e){this.isLoading=e,this.listContainerNode.toggleClass("loading",e)},handleLoadCommentsComplete:function(){this.listContainerNode.removeClass("loading")},showCommentLoading:function(e){e?this.showBalls(!1):this.hideBalls()},showCommentAddLoading:function(e){e?this.showBalls(!0):this.hideBalls()},updateComments:function(t){return t?(this.updateLoadButton(),this.prependComments(t)):e.Promise.resolve()},prependComments:function(t){var i=this,n=[],o=[];return t.forEach(function(t){var s=t.toJSON(),a=Object.assign(s,{appContext:i.appContext,showPermalink:i.commentsViewHelper.config.commentListConfig.showPermalinks});a.isSubjectOwner=i.commentsViewHelper.commentsObj.isSubjectOwner;var m=new e.Views["comment-item-view"](a),r=m.initialize(a).then(function(){m.activate()});o.push(m),n.push(r)}),e.Promise.all(n).then(function(){i.prependCommentViewsToDom(o)})},prependCommentViewsToDom:function(t){var i,n=this;t.forEach(function(t){(i=e.Node.create('<li class="comment-list-item"></li>')).append(t.get("container")),n.commentsListNode.prepend(i)}),this.commentsViewHelper.commentsObj.flimojiParser.emojifyTarget({inputElements:["["+e.config.flickr.emojis.parserAttr+"]"],useSprites:!1,iconsPath:e.config.flickr.urls.assetRoot+"/images/joypixels",container:this.get("container").getDOMNode()})},handleLoadMoreClick:function(){var e=this;this.isFetchingComments||this.getMoreComments().then(function(){e.updateLoadButton()})},updateLoadButton:function(){var e;e=this.commentsViewHelper.getLoadButtonMessage(),this.loadMoreButton.toggleClass("hidden",!!this.commentsViewHelper.commentsObj.endOfComments),this.loadMoreButton.set("text",e)}})},"@VERSION@",{requires:["flickr-view","comment-list-view","hermes-template-standard-comment-list-view"],langBundles:["common","comments","photo-page-scrappy"]});YUI.add("hermes-template-photo-comments-view",function(e,t){var n=e.Template.Handlebars.revive({1:function(e,t,n,l,a){return" scrollable"},3:function(e,t,n,l,a){return"\t\t\t"+e.escapeExpression((n.outlet||t&&t.outlet||n.helperMissing).call(null!=t?t:{},null!=t?t["scrollable-comment-list-view"]:t,{name:"outlet",hash:{},data:a}))+"\n"},5:function(e,t,n,l,a){return"\t\t\t"+e.escapeExpression((n.outlet||t&&t.outlet||n.helperMissing).call(null!=t?t:{},null!=t?t["standard-comment-list-view"]:t,{name:"outlet",hash:{},data:a}))+"\n"},compiler:[7,">= 4.0.0"],main:function(e,t,n,l,a){var s,i=null!=t?t:{};return'<div class="photo-comments with-emoji-picker'+(null!=(s=n.if.call(i,null!=t?t.isScrollable:t,{name:"if",hash:{},fn:e.program(1,a,0),inverse:e.noop,data:a}))?s:"")+'">\n\t<section class="comments-list-section">\n'+(null!=(s=n.if.call(i,null!=t?t.isScrollable:t,{name:"if",hash:{},fn:e.program(3,a,0),inverse:e.program(5,a,0),data:a}))?s:"")+'\t</section>\n\n\t<section class="add-comment-section">\n\t\t'+e.escapeExpression((n.outlet||t&&t.outlet||n.helperMissing).call(i,null!=t?t["add-comment-view"]:t,{name:"outlet",hash:{},data:a}))+"\n\t</section>\n</div>\n"},useData:!0}),l={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(l[t]=n)}),e.Template.register("hermes/photo-comments-view",function(t,a){return a=a||{},a.partials=a.partials?e.merge(l,a.partials):l,n(t,a)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-comment-edit",function(e,t){var n=e.Template.Handlebars.revive({1:function(e,t,n,a,s){return""},3:function(e,t,n,a,s){var i;return'\t\t\t<textarea class="edit-field">'+e.escapeExpression("function"==typeof(i=null!=(i=n.content||(null!=t?t.content:t))?i:n.helperMissing)?i.call(null!=t?t:{},{name:"content",hash:{},data:s}):i)+"</textarea>\n"},compiler:[7,">= 4.0.0"],main:function(e,t,n,a,s){var i,l=null!=t?t:{},r=n.helperMissing,o=e.escapeExpression;return'<div class="comment-edit">\n\t<div class="text-area-wrapper">\n'+(null!=(i=(n.isFlipped||t&&t.isFlipped||r).call(l,"enable-custom-text-parser",{name:"isFlipped",hash:{},fn:e.program(1,s,0),inverse:e.program(3,s,0),data:s}))?i:"")+'\t</div>\n\t<div class="buttons edit-comment-buttons">\n\t\t<button type="button" class="mini alt cancel-edit-button">'+o((n.intlMessage||t&&t.intlMessage||r).call(l,{name:"intlMessage",hash:{intlName:"common.CANCEL"},data:s}))+'</button>\n\t\t<button type="button" class="mini action submit-edit-button">'+o((n.intlMessage||t&&t.intlMessage||r).call(l,{name:"intlMessage",hash:{intlName:"common.DONE"},data:s}))+"</button>\n\t</div>\n</div>"},useData:!0}),a={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(a[t]=n)}),e.Template.register("hermes/comment-edit",function(t,s){return s=s||{},s.partials=s.partials?e.merge(a,s.partials):a,n(t,s)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("comments-view-helper",function(e,t){require("hermes-core/flog")(t);var o=e.mix({langBundles:["common","comments","photo-page-scrappy"]},e.Localizable);e.CommentsViewHelper=function(t,n){var i=n,s=n.commentListConfig,m=(n.addCommentConfig,{commentsObj:new{photo:function(){return{load:function(){var o,n=this,m=/#comment/g;YUI.Env.isServer||(o=e.config.win.location.hash),this.renderedCommentModels=[],this.commentingEnabled=!0,this.perPage=s.modelConfig.perPage,this.firstPerPage=s.modelConfig.firstPerPage,this.permalinkHash=o;var l=[t.getModelRegistry(s.modelConfig.commentModelRegistryName).then(function(e){n.commentModelRegistry=e}),t.getModel("photo-engagement-models",i.photoId).then(function(e){n.engagementModel=e,o&&m.test(o)&&(n.perPage=this.engagementModel.getValue("commentCount"),n.firstPerPage=this.engagementModel.getValue("commentCount"))}.bind(this)),t.getModel("photo-models",{id:i.photoId}).then(function(e){n.photoModel=e,n.commentingEnabled=!t.getViewer().signedIn||n.photoModel.getValue("canComment")})];if(t.getViewer().signedIn&&l.push(t.getModel("person-models",{id:t.getViewer().nsid}).then(function(e){n.userModel=e})),!this.flimojis){var r=require("@flickr/flimojis");this.flimojiParser=new r.EmojiParser}return e.Promise.all(l)},loadComments:function(){var o=this,n=[];return n.push(t.getModel(s.modelConfig.listRegistryName,{id:s.modelConfig.modelId}).then(function(e){o.listModel=e})),n.push(t.getModel("photo-models",s.modelConfig.modelId).then(function(e){o.isSubjectOwner=t.getViewer().nsid===e.getValue("owner").getValue("nsid")})),n.push(t.getModel("photo-engagement-models",i.photoId).then(function(e){o.engagementModel=e})),e.Promise.all(n)},getLoadButtonMessage:function(){var e=this.calculateRemainingCount();return o.intlMessage({intlName:"photo-page-scrappy.VIEW_MORE_PREVIOUS_COMMENTS",count:e})},calculateRemainingCount:function(){var e=this.listModel.getValue(s.modelConfig.collectionName),t=this.engagementModel.getValue("commentCount"),o=e.getList().length;return t>o+s.modelConfig.perPage?s.modelConfig.perPage:t<=o+s.modelConfig.perPage?t-o:0},getPlaceholderMessage:function(){return o.intlMessage({intlName:"comments.ADD_PHOTO_COMMENT",mediaType:this.photoModel.getValue("mediaType")})},deleteComment:function(e){return this.commentModelRegistry.remoteDelete(e)},updateComment:function(e,t){var o=this;return this.commentModelRegistry.get(e).then(function(n){return n.setValue("content",t),o.commentModelRegistry.remoteUpdate(e)})},addComment:function(e){return this.commentModelRegistry.remoteCreate({photoId:i.photoId,commentText:e})},getMoreComments:function(){var t=this,o=this.isFirstPageRendered?this.perPage:this.firstPerPage,n=this.renderedCommentModels.length,i=this.renderedCommentModels.length,m=t.listModel.getValue(s.modelConfig.collectionName).getList(),l=[];if(0===this.engagementModel.getValue("commentCount"))return this.endOfComments=!0,e.Promise.resolve();if(m.length>=n+o||this.endOfComments){for(var r=n;r<n+o;r++)m[r]&&l.push(m[r]);return e.Promise.resolve(l)}return this.listModel.getValue(s.modelConfig.collectionName).getRange({offset:i,limit:o}).then(function(e){return(e.length<o||t.listModel.getValue(s.modelConfig.collectionName).getList().length>=t.engagementModel.getValue("commentCount"))&&(t.endOfComments=!0),e.forEach(function(e){t.renderedCommentModels.push(e)}),e})}}},gallery:function(){return{load:function(){var o=this;this.renderedCommentModels=[],this.commentingEnabled=!0;var n=[t.getModelRegistry(s.modelConfig.commentModelRegistryName).then(function(e){o.commentModelRegistry=e}),t.getModel("gallery-info-models",{id:i.galleryId}).then(function(e){o.galleryInfoModel=e})];if(t.getViewer().signedIn&&n.push(t.getModel("person-models",{id:t.getViewer().nsid}).then(function(e){o.userModel=e})),!this.flimojis){var m=require("@flickr/flimojis");this.flimojiParser=new m.EmojiParser}return e.Promise.all(n)},loadComments:function(){var e=this;return t.getModel(s.modelConfig.listRegistryName,{id:s.modelConfig.modelId}).then(function(o){return e.listModel=o,e.isSubjectOwner=t.getViewer().signedIn&&t.getViewer().nsid===o.getValue("owner").getValue("nsid"),o})},getLoadButtonMessage:function(){var e=this.calculateRemainingCount();return o.intlMessage({intlName:"photo-page-scrappy.VIEW_MORE_PREVIOUS_COMMENTS",count:e})},calculateRemainingCount:function(){var e=this.listModel.getValue(s.modelConfig.collectionName),t=e.totalItems>e.getList().length?e.totalItems-e.getList().length:0;return t>s.modelConfig.perPage?s.modelConfig.perPage:t},getPlaceholderMessage:function(){return o.intlMessage({intlName:"comments.ADD_GALLERY_COMMENT"})},deleteComment:function(e){return this.commentModelRegistry.deleteRemote(e)},updateComment:function(e,t){return this.commentModelRegistry.updateRemote(e,t)},addComment:function(e){return this.commentModelRegistry.remoteCreate({galleryId:this.listModel.getValue("id"),galleryOwnerId:this.listModel.getValue("owner").getValue("id"),commentText:e,authorId:this.userModel.getValue("id")})},getMoreComments:function(){var t=this,o=this.isFirstPageRendered?s.modelConfig.perPage:s.modelConfig.firstPerPage,n=this.listModel.getValue(s.modelConfig.collectionName).getList(),i=this.renderedCommentModels.length,m=[];if(this.endOfComments="-1"===this.listModel.getValue(s.modelConfig.listRegistryContinuationName),n.length>=i+o||this.endOfComments){for(var l=i;l<i+o;l++)n[l]&&m.push(n[l]);return e.Promise.resolve(m)}return this.listModel.getCommentsByContinuation(o).then(function(e){return"-1"===t.listModel.getValue(s.modelConfig.listRegistryContinuationName)&&(t.endOfComments=!0),e.forEach(function(e){t.renderedCommentModels.push(e)}),e})},reset:function(){this.renderedCommentModels=[],this.isFirstPageRendered=!1,this.endOfComments=!1;var e=this.listModel.getValue(s.modelConfig.collectionName);e.getList().forEach(function(t){e.remove(t.id)}),this.listModel.setValue(s.modelConfig.listRegistryContinuationName,"0")}}}}[i.type],config:i,loadPromise:void 0,load:function(){return this.loadPromise||(this.loadPromise=this.commentsObj.load()),this.loadPromise},loadComments:function(){return this.commentsObj.loadComments()},addComment:function(e){return this.commentsObj.addComment(e)},deleteComment:function(e){return this.commentsObj.deleteComment(e)},updateComment:function(e,t){return this.commentsObj.updateComment(e,t)},getLoadButtonMessage:function(){return this.commentsObj.getLoadButtonMessage()},getPlaceholderMessage:function(){return this.commentsObj.getAddPlaceholderMessage()},getMoreComments:function(){return this.commentsObj.getMoreComments()},reset:function(){return this.commentsObj.reset()}});return e.augment(m,e.EventTarget),m}},"@VERSION@",{requires:["event-custom"],langBundles:["common","comments","photo-page-scrappy"],optionalRequires:["flimojis"]});YUI.add("photo-comments-view",function(e,t){require("hermes-core/flog")(t);e.namespace("Views")[this.name]=e.Base.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){var i;YUI.Env.isServer||(i=e.config.win.location.hash),this.params=t,this.config=this.params.photoCommentsViewConfig||this.params||{},this.signedIn=this.appContext.getViewer().signedIn,this.commentsViewHelper=new e.CommentsViewHelper(this.appContext,{photoId:this.config.photoId,type:"photo",commentListConfig:{type:"photo",isScrollable:this.config.isScrollable,showPermalinks:this.config.showPermalinks,modelConfig:{listRegistryName:"photo-comments-models",modelId:this.config.photoId,collectionName:"comments",commentModelRegistryName:"comment-models",perPage:this.config.perPage||200,firstPerPage:this.config.firstPerPage||16,loadAllInitially:i&&/#comment/g.test(i)}},addCommentConfig:{type:"photo",addCommentText:this.config.addCommentText,modelConfig:{commentModelRegistryName:"comment-models"}}}),this.params.commentListConfig=Object.assign({commentsViewHelper:this.commentsViewHelper},this.commentsViewHelper.config.commentListConfig),this.params.addCommentConfig=Object.assign({commentsViewHelper:this.commentsViewHelper},this.commentsViewHelper.config.addCommentConfig),this.params.mentionsApiConfig={type:"photos",params:{photo_id:null}}},subviewConfig:{"scrollable-comment-list-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1},"standard-comment-list-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1},"add-comment-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1}},loadState:function(){return this.commentsViewHelper.load()},buildContainer:function(){this.setContainerWithTemplate("photo-comments-view",{user:this.signedIn?this.commentsViewHelper.commentsObj.userModel.toJSON():null,signedIn:this.signedIn,isScrollable:this.config.isScrollable})},activate:function(){this.get("container");this.config.isScrollable?this.commentListView=this.subviews["scrollable-comment-list-view"]:this.commentListView=this.subviews["standard-comment-list-view"],this.addCommentView=this.subviews["add-comment-view"]},delayPromise:function(t,i){return new e.Promise(function(e){setTimeout(function(){return e(i())},t)})},onSubviewEvent:function(e,t){var i;if(t&&t[0])switch((i=t[0]).eventName){case"replyClicked":this.addCommentView.addReplyMessage(i.pathAliasOrNSID,!1);break;case"emptyCommentContainer":this.addCommentView.focusCommentBox();break;case"commentAddLoading":this.commentListView.showCommentAddLoading(i.isLoading);break;case"commentAdded":this.commentListView.appendNewComment(i.commentModel),this.commentsViewHelper.commentsObj.listModel.getValue(this.params.commentListConfig.modelConfig.collectionName).prependToList(i.commentModel),this.commentsViewHelper.commentsObj.engagementModel.setValue("commentCount",this.commentsViewHelper.commentsObj.engagementModel.getValue("commentCount")+1),this.fire("commentAdded");break;case"commentDeleted":this.commentsViewHelper.commentsObj.listModel.getValue(this.params.commentListConfig.modelConfig.collectionName).removeFromList(i.commentModelId),this.commentsViewHelper.commentsObj.engagementModel.setValue("commentCount",this.commentsViewHelper.commentsObj.engagementModel.getValue("commentCount")-1),this.fire("commentDeleted")}}})},"@VERSION@",{requires:["flickr-view","comment-item-view","add-comment-view","scrollable-comment-list-view","standard-comment-list-view","hermes-template-photo-comments-view","hermes-template-comment-edit","comments-view-helper"],langBundles:["gallery","stats","comments","common"]});
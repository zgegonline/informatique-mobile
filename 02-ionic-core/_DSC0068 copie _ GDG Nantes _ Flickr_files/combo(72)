YUI.add("account-menu-view",function(e,t){"use strict";var o=require("hermes-core/flog")(t),n=new e.SubscriptionsHelper;e.namespace("Views")[this.name]=e.Base.create("account-menu-view",e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this},loadState:function(){var t=this,o=[],n=this.appContext.getViewer();return n.signedIn?(t.set("user",{signedIn:!0,csrf:this.appContext.auth.csrf?this.appContext.auth.csrf:""}),o.push(this.appContext.getModel("person-models",n.nsid).then(function(o){var n=o.toJSON();Object.keys(n.buddyicon||{}).forEach(function(e){n.buddyicon[e]||(n.buddyicon[e]=n.buddyicon.default)}),t.set("user",e.merge(t.get("user"),n))})),o.push(t.appContext.getModel("person-profile-models",n.nsid).then(function(o){var n=o.toJSON();n.unreadMessages=parseInt(n.unreadMessages,10),n.storageUsed=parseInt(n.storageUsed,10),n.storageTotal=parseInt(n.storageTotal,10),t.set("profileModel",o),t.set("user",e.merge(t.get("user"),n))})),e.Promise.all(o).then(function(){t.set("showOverLimitWarning",t.appContext.getCookie(e.config.flickr.upload_blocking.dismiss_over_upload_limit_message_cookie_name)&&e.UserLimitsHelper.isOverARRLimit(t.get("profileModel"),t.appContext))})):(t.set("user",{signedIn:!1}),e.Promise.resolve())},buildContainer:function(){return this.setContainerWithTemplate("account-menu",this.toJSON()),this},toJSON:function(){var t=e.merge(this.get("user")),o=this.appContext.lang;return parseInt(t.photoCount,10)>1?t.pluralPhotos=!0:t.pluralPhotos=!1,parseInt(t.photoCount,10)<1&&(t.photoCount=!1),t.photoCount>1e3&&(t.photoCount=Math.round(t.photoCount/1e3),t.oneK=!0),t.isPro?t.storageTotalFormatted=t.storageTotal<0?"":e.Handlebars.helpers.friendlyDataSize(t.storageTotal):t.hasUnlimitedStorage?t.storageTotalFormatted="":t.has1TB?t.storageTotalFormatted="1TB":t.has2TB?t.storageTotalFormatted="2TB":t.storageTotalFormatted=t.storageTotal<0?"":e.Handlebars.helpers.friendlyDataSize(t.storageTotal),"vi-vn"===o.toLowerCase()&&(o="vn-VN"),t.storageUsedPercentage=Math.floor(1e3*t.storageUsed/t.storageTotal)/10||"0.0",t.storageUsedFormatted=e.Handlebars.helpers.friendlyDataSize(t.storageUsed),t.barWidth=Math.floor(t.storageUsedPercentage/100*293),t.unreadMessages=t.unreadMessages>9999?"9999+":t.unreadMessages,{user:t,helpLocaleKey:o.replace("-","_")||"en_US",flippers:this.appContext.flipper.toJSON(),showOverLimitWarning:this.get("showOverLimitWarning")}},activate:function(){e.on("notifications:openAccountMenuClicked",function(e){this.openUserAccountCard(!0)}.bind(this)),setTimeout(function(){this.get("container").on(["click","keydown"],function(e){"click"!==e.type&&13!==e.keyCode&&32!==e.keyCode||(this.appContext.flipper.isFlipped("enable-2018-user-account-card")?(e.preventDefault(),e.stopPropagation(),this.openUserAccountCard()):!this.accountMenuDialog||this.accountMenuDialog.isClosed?this.openMenu(e):this.closeMenu(e))},this)}.bind(this),350)},openMenu:function(t){var o,n=this.get("container");return t.preventDefault(),t.stopPropagation(),this.fire("open"),this.accountMenuDialog||(o=this.templates("account-menu-card"),this.accountMenuDialog=new e.Views.FluidDroparound({appContext:this.appContext,dismissOnOverlayClick:!0,showDropArrow:!0,showOverlay:!1,width:322,height:"auto",anchorOffsetHorizontal:5,observePageResize:!0,anchorElement:n.one(".c-account-menu"),keyboardAnchorElement:n.one("a[aria-haspopup=true]"),htmlMessage:o({attrs:this.toJSON()}),positionFixed:!0}),this.showGetProButton()),this.accountMenuDialog.show(),this.on("open",this.showGetProButton),this},openUserAccountCard:function(t){var o=this,n=this.get("container"),s=new e.Views["user-account-card-view"]({appContext:this.appContext,showHighlight:t});this.accountMenu=new e.Views.FluidDroparound({appContext:this.appContext,dismissOnOverlayClick:!0,showDropArrow:!0,preferTop:!0,width:300,height:"auto",autoSizeToContent:!0,anchorOffsetVertical:-6,anchorOffsetHorizontal:5,anchorElement:n.one(".c-account-menu"),keyboardAnchorElement:n.one("a[aria-haspopup=true]"),subview:s,contentPadding:0,preventPageScrollOnScroll:!0,useDefaultKeyboardNavigation:!1,classList:"user-account-card-droparound",positionFixed:!0}),this.accountMenu.show(),e.on("accountCard:close",function(){o.accountMenu.close()})},closeMenu:function(e){e&&e.preventDefault(),this.accountMenuDialog&&this.accountMenuDialog.close()},showGetProButton:function(){var t,s=!1,i=!1,a=[],r=this.appContext.getViewer(),u=!1;if(this.appContext.flipper.isFlipped("enable-digital-river")){var c=n.getShopperCurrencyAndLocale();t={id:r.nsid,currency:c.currency,locale:c.locale}}else t=r.nsid;a.push(this.appContext.getModel("subscription-info-models",t).then(function(e){var t=e.getValue("products");!(s=n.canPurchaseAtLeastOnePlan(t))&&this.accountMenuDialog.get("container").one(".upgrade")&&this.accountMenuDialog.get("container").one(".upgrade").remove(!0)}.bind(this))),a.push(this.appContext.getModel("subscription-history-list-models",r.nsid).then(function(e){if(e.getValue("subscriptions")){if(n.isOneTimePro(e))return i=!1,void(u=!0);i=n.isUserOnActiveButClosedPro(e);(this.get("user").isPro||this.get("user").hasUnlimitedStorage)&&(i=!0)}}.bind(this))),e.Promise.all(a).then(function(){var e=this.templates("account-menu-card-get-pro-button")({isOneTimePro:u,canPurchase:!i&&s,canResubscribe:i});this.accountMenuDialog.get("container").one(".upgrade").replace(e),this.accountMenuDialog.get("container").one(".content").setStyles({height:"auto"})}.bind(this),function(e){o.warn("Error fetching model.",{err:e})})},destructor:function(){this.accountMenuDialog&&(this.accountMenuDialog.destroy(),this.accountMenuDialog=null)}})},"@VERSION@",{requires:["flickr-view","hermes-template-account-menu","hermes-template-account-menu-dialog-styleguide","hermes-template-account-menu-card","hermes-template-account-menu-card-get-pro-button","fluid-droparound-view","subscription-history-list-models","subscription-info-models","user-account-card-view","subscriptions-helper"],optional:["person-models","person-profile-models"],langBundles:["account-menu","common","autosuggest"]});